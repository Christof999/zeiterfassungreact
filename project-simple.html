<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vereinfachte Projektdetails - Lauffer Zeiterfassung</title>
    <!-- Firebase-SDKs einbinden -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Helper-Funktion f√ºr PDF Export -->
    <script>
        // Konvertiert Firebase Storage URLs in Base64 Data URLs f√ºr die PDF-Erstellung
        async function getImageAsDataUrl(url) {
            return new Promise((resolve, reject) => {
                const storageRef = firebase.storage().refFromURL(url);
                
                // Wenn URL nicht formatiert werden kann, fallback auf Original URL
                if (!storageRef) {
                    console.warn('Konnte URL nicht als Storage Referenz formatieren:', url);
                    resolve(url);
                    return;
                }
                
                // Token f√ºr direkten Zugriff generieren
                storageRef.getDownloadURL()
                    .then(directUrl => {
                        // Bild √ºber direkte URL laden
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        
                        img.onload = () => {
                            // In Canvas zeichnen und als Data URL umwandeln
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg', 0.9));
                        };
                        
                        img.onerror = () => {
                            console.error('Fehler beim Laden des Bildes:', directUrl);
                            reject(new Error('Bild konnte nicht geladen werden'));
                        };
                        
                        // Timestamp hinzuf√ºgen um Caching zu vermeiden
                        img.src = `${directUrl}&t=${new Date().getTime()}`;
                    })
                    .catch(error => {
                        console.error('Fehler beim Abrufen der Download-URL:', error);
                        reject(error);
                    });
            });
        }
    </script>
    
    <!-- Firebase-Konfiguration -->
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>
    
    <!-- PDF Export Bibliotheken -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Datenservice und Hilfsfunktionen -->
    <script src="data.js"></script>
    <!-- Alle Funktionen direkt in dieser Datei, keine externen Abh√§ngigkeiten -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="report-styles.css">
    
    <style>
        /* Apple-inspiriertes Design f√ºr project-simple.html */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 0.5px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .actions-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: var(--text-color);
            font-weight: 600;
        }
        
        h1 {
            margin-bottom: 1rem;
            font-size: 28px;
            border-bottom: 0.5px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 22px;
            margin-bottom: 15px;
        }
        
        /* Zuklappbare Sections */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header:hover {
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 4px;
            padding-left: 10px;
            padding-right: 10px;
        }
        
        .section-header h2 {
            margin-bottom: 0;
            flex: 1;
        }
        
        .collapse-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            color: var(--text-color);
            font-size: 18px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .collapse-toggle-btn:hover {
            color: var(--primary-color);
        }
        
        .section-header.expanded .collapse-toggle-btn {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            display: block;
        }
        
        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .collapsible-content.expanded {
            max-height: 10000px !important;
            opacity: 1;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: var(--card-background);
            box-shadow: var(--shadow);
            border-radius: 12px;
            border: 0.5px solid var(--border-color);
        }
        
        .info-box {
            background-color: var(--light-color);
            border-left: 3px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            margin: 5px 0;
            font-size: 16px;
        }
        
        .btn:hover {
            background-color: #2AB550;
            opacity: 0.9;
        }
        
        .btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .btn.btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn.btn-secondary {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 0.5px solid var(--border-color);
        }
        
        .btn.btn-secondary:hover {
            background-color: #E5E5EA;
        }
        
        .btn.btn-export {
            background-color: var(--light-color);
            color: var(--text-color);
            border: 0.5px solid var(--border-color);
        }
        
        .btn.btn-export:hover {
            background-color: #E5E5EA;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            box-shadow: var(--shadow);
            border: 0.5px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--card-background);
        }
        
        th, td {
            border-bottom: 0.5px solid var(--border-color);
            padding: 12px 16px;
            text-align: left;
        }
        
        th {
            background-color: var(--light-color);
            color: var(--text-color);
            font-weight: 600;
            font-size: 14px;
        }
        
        tr:nth-child(even) {
            background-color: var(--card-background);
        }
        
        tr:hover {
            background-color: var(--light-color);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        section {
            margin-bottom: 25px;
            padding-bottom: 5px;
        }
        
        /* PDF-optimierte Galeriedarstellung */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        /* PDF-optimierte Galeriedarstellung mit 4 Bildern pro Seite */
        @media print {
            .gallery {
                grid-template-columns: 1fr 1fr;
                page-break-inside: avoid;
                grid-template-rows: auto;
                gap: 20px;
            }
            .gallery-item {
                page-break-inside: avoid;
                margin-bottom: 20px;
                break-inside: avoid;
            }
            .gallery-item:nth-child(4n+1) {
                break-before: page;
            }
            /* Spezielle Styles f√ºr die ersten 4 Items (keine Seitenumbruch davor) */
            .gallery-item:nth-child(1),
            .gallery-item:nth-child(2),
            .gallery-item:nth-child(3),
            .gallery-item:nth-child(4) {
                break-before: auto;
            }
            /* Gr√∂√üere Bilder im PDF */
            .gallery-img {
                height: 300px !important;
                object-fit: contain !important;
            }
            /* Kommentare besser sichtbar machen */
            .gallery-caption {
                font-size: 14px !important;
                margin: 10px 0 !important;
                font-weight: bold !important;
                color: black !important;
                padding: 5px !important;
            }
            .image-comment {
                margin-top: 5px !important;
                font-size: 13px !important;
                color: black !important;
                background-color: #f9f9f9 !important;
                padding: 8px !important;
                border-left: 3px solid #5e8c2f !important;
                page-break-inside: avoid !important;
            }
        }
        .gallery-item {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .gallery-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .gallery-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        /* Spezielle Klasse f√ºr PDF-Export Modus */
        .pdf-export-mode .gallery-img {
            height: 300px;
            object-fit: contain;
        }
        
        .pdf-export-mode .image-comment {
            background-color: #f9f9f9;
            padding: 8px;
            border-left: 3px solid #5e8c2f;
            margin-top: 8px;
        }
        
        .gallery-caption {
            margin-top: 8px;
            font-size: 14px;
            text-align: center;
            color: #555;
            overflow-wrap: break-word;
        }
        .btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            text-decoration: none;
        }
        .btn:hover {
            background-color: #005a9e;
        }
        
        /* Lightbox Stile */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .lightbox.active {
            display: flex;
        }
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 80%;
            margin: 20px;
        }
        .lightbox-img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        .lightbox-caption {
            color: white;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 4px;
            max-width: 80%;
            text-align: center;
        }
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .lightbox-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 0 20px;
            box-sizing: border-box;
        }
        .lightbox-prev, .lightbox-next {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lightbox-prev:hover, .lightbox-next:hover {
            background: rgba(0,0,0,0.8);
        }
        
        /* Zeiteintrag-Bericht Modal Styles */
        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
        }
        
        .report-modal.visible {
            display: block;
        }
        
        .report-modal-content {
            position: relative;
            background-color: #fff;
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .report-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .report-modal-close:hover {
            color: #000;
        }
        
        /* Edit Time Entry Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            overflow-y: auto;
        }
        
        .modal.visible {
            display: block;
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0 0 15px 0;
            color: #5e8c2f;
        }
        
        .close-modal {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .modal form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #5e8c2f;
            outline: none;
            box-shadow: 0 0 5px rgba(94, 140, 47, 0.3);
        }
        
        .form-group input[readonly] {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-primary {
            background-color: #5e8c2f;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #4a6f24;
        }
        
        .report-btn {
            display: inline-block;
            padding: 5px 10px;
            background-color: #5e8c2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .report-btn:hover {
            background-color: #4a7024;
        }
        
        .report-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .report-section h3 {
            color: #5e8c2f;
            margin-bottom: 10px;
        }
        
        /* Nachkalkulation Styles */
        .nachkalkulation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .nachkalkulation-table th {
            background-color: #5e8c2f;
            color: white;
            text-align: left;
            padding: 10px;
        }
        
        .nachkalkulation-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
        }
        
        .nachkalkulation-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .nachkalkulation-table .total-row {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        
        .nachkalkulation-table .grand-total-row {
            font-weight: bold;
            background-color: #e6e6e6;
            font-size: 1.1em;
        }
        
        /* Styling f√ºr Admin-Zeiteintragsformular */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .admin-controls {
            margin-bottom: 15px;
        }

        /* Verstecke Report-Buttons f√ºr Nicht-Administratoren */
        body.employee-mode .report-btn,
        body.employee-mode .report-button,
        body.employee-mode button[class*="report"],
        body.employee-mode button[onclick*="Report"],
        body.employee-mode button[onclick*="report"],
        body.employee-mode button:not(.edit-entry-btn):not(.delete-entry-btn):not(.btn-primary):not(.btn-export) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Verstecke Edit- und L√∂schen-Buttons f√ºr Nicht-Administratoren */
        body.employee-mode .edit-entry-btn,
        body.employee-mode .delete-entry-btn,
        body.employee-mode .edit-btn,
        body.employee-mode button[class*="edit"],
        body.employee-mode button[class*="delete"] {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Edit Button Styles */
        .edit-entry-btn {
            background-color: #ffc107;
            color: #212529;
            border: 1px solid #ffc107;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-entry-btn:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            transform: translateY(-1px);
        }

        /* Delete Button Styles */
        .delete-entry-btn {
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-entry-btn:hover {
            background-color: #c82333;
            border-color: #bd2130;
            transform: translateY(-1px);
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 12px;
            line-height: 1.2;
        }
        
        /* Report Button Styles - kleiner machen f√ºr nebeneinander */
        .report-btn {
            background-color: #17a2b8;
            color: white;
            border: 1px solid #17a2b8;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-btn:hover {
            background-color: #138496;
            border-color: #117a8b;
        }

        /* Verstecke alle Report-bezogenen Buttons f√ºr normale Mitarbeiter */
        body.employee-mode .report-btn,
        body.employee-mode .report-button,
        body.employee-mode button[class*="report"],
        body.employee-mode .admin-controls {
            display: none !important;
        }
        
        /* Table Action Column Styles */
        /* Erste Spalte - Bearbeitung */
        #time-entries-table th:first-child,
        #time-entries-table td:first-child {
            text-align: center;
            width: 100px;
            white-space: nowrap;
        }
        
        /* Letzte Spalte - L√∂schen */
        #time-entries-table th:last-child,
        #time-entries-table td:last-child {
            text-align: center;
            width: 100px;
            white-space: nowrap;
        }
        
        /* Button Container f√ºr nebeneinander stehende Buttons */
        .button-container {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }
        
        .report-detail {
            display: flex;
            margin-bottom: 8px;
        }
        
        .report-label {
            font-weight: bold;
            width: 180px;
            flex-shrink: 0;
        }
        
        .report-value {
            flex-grow: 1;
        }
        
        .location-link {
            color: #0078d4;
            text-decoration: underline;
            cursor: pointer;
        }
        
        @media (max-width: 600px) {
            .report-detail {
                flex-direction: column;
            }
            
            .report-label {
                width: 100%;
                margin-bottom: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Zeiteintrag-Bericht Modal (einzige Instanz) -->
    <div id="time-entry-report-modal" class="report-modal">
        <div class="report-modal-content">
            <button class="report-modal-close" type="button" aria-label="Schlie√üen">&times;</button>
            <div id="time-entry-report-content"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="header-container">
            <h1 id="project-title">Projektdetails</h1>
            <div class="actions-container">
                <button id="export-pdf-btn" class="btn btn-export"><i class="fas fa-file-pdf"></i> PDF exportieren</button>
                <a href="admin.html" id="back-link" class="btn"><i class="fas fa-arrow-left"></i> Zur√ºck zur Projekt√ºbersicht</a>
            </div>
        </div>
        <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Hier finden Sie alle Details zum ausgew√§hlten Projekt sowie zugeh√∂rige Zeiterfassungseintr√§ge, Baustellenfotos und Dokumente. Mit dem Export-Button k√∂nnen Sie einen vollst√§ndigen PDF-Bericht erstellen.</p>
        </div>
        
        <div id="pdf-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: #5e8c2f;">LAUFFER Gartenbau - Projektbericht</h2>
            </div>
            
            <section>
                <h2><i class="fas fa-briefcase"></i> Projektdetails</h2>
                <div class="info-box" id="project-info">
                    Projektinformationen werden geladen...
                </div>
            </section>
            
            <section>
                <div class="section-header collapsible-header" data-target="time-entries-section">
                    <h2><i class="fas fa-clock"></i> Zeiteintr√§ge</h2>
                    <button class="collapse-toggle-btn" aria-label="Ein-/Ausklappen">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapsible-content collapsed" id="time-entries-section">
                    <div class="admin-controls" id="admin-time-entry-controls">
                        <button id="add-time-entry-btn" class="btn btn-primary" title="Neuen Zeiteintrag f√ºr Mitarbeiter erstellen">
                            <i class="fas fa-plus-circle"></i> Zeiteintrag hinzuf√ºgen
                        </button>
                    </div>
                    <div id="time-entries-container">
                    <p>Zeiteintr√§ge werden geladen...</p>
                    <table id="time-entries-table" class="time-entries">
                        <thead>
                            <tr>
                                <th>Bearbeitung</th>
                                <th>Mitarbeiter</th>
                                <th>Datum</th>
                                <th>Stempelzeit Ein</th>
                                <th>Stempelzeit Aus</th>
                                <th>Arbeitszeit</th>
                                <th>L√∂schen</th>
                            </tr>
                        </thead>
                        <tbody id="time-entries-body">
                            <!-- Zeiteintr√§ge werden hier eingef√ºgt -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </section>
            
            <section>
                <div class="section-header collapsible-header" data-target="vehicle-usages-section">
                    <h2><i class="fas fa-car"></i> Fahrzeugbuchungen</h2>
                    <button class="collapse-toggle-btn" aria-label="Ein-/Ausklappen">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapsible-content collapsed" id="vehicle-usages-section">
                    <div class="admin-controls" id="admin-vehicle-usage-controls">
                        <button id="add-vehicle-booking-btn" class="btn btn-primary" title="Neue Fahrzeugbuchung erstellen">
                            <i class="fas fa-plus"></i> Fahrzeugbuchung hinzuf√ºgen
                        </button>
                    </div>
                    <div id="vehicle-usages-container">
                    <p>Fahrzeugbuchungen werden geladen...</p>
                    <table id="vehicle-usages-table">
                        <thead>
                            <tr>
                                <th>Mitarbeiter</th>
                                <th>Fahrzeug</th>
                                <th>Datum</th>
                                <th>Startkilometer</th>
                                <th>Endkilometer</th>
                                <th>Gefahrene km</th>
                                <th>Notizen</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-usages-body">
                            <!-- Fahrzeugbuchungen werden hier eingef√ºgt -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-calculator"></i> Nachkalkulation</h2>
                <div id="nachkalkulation-container">
                    <div id="nachkalkulation-content">
                        <p>Nachkalkulation wird berechnet...</p>
                    </div>
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-camera"></i> Baustellenbilder</h2>
                <div id="construction-images" class="gallery">
                    <p>Bilder werden geladen...</p>
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-file-alt"></i> Lieferscheine und Dokumente</h2>
                <div id="documents-gallery" class="gallery">
                    <p>Dokumente werden geladen...</p>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        // DEBUG: Sofortige Ausgabe zur Verfolgung
        console.log('=== PROJECT-SIMPLE.HTML SCRIPT WIRD AUSGEF√úHRT ===');
        console.log('Zeitpunkt:', new Date().toISOString());
        
        // Firebase sollte bereits durch firebase-config.js initialisiert sein
        console.log('üîß Firebase bereits initialisiert:', !!firebase);
        console.log('üîß Firebase Apps:', firebase.apps ? firebase.apps.map(app => app.name) : 'nicht verf√ºgbar');
        console.log('üîß Firestore verf√ºgbar:', typeof firebase.firestore !== 'undefined');
        console.log('üîß Storage verf√ºgbar:', typeof firebase.storage !== 'undefined');
        
        // Globale Variablen  
        let projectId = null;
        let allProjectFiles = null; // Cache f√ºr alle Projektdateien
        
        // DOM-Elemente - werden nach DOM-Load initialisiert
        let pdfContent, exportBtn, projectTitleEl, projectInfoEl, timeEntriesBodyEl, vehicleUsagesBodyEl, constructionImagesEl, documentsGalleryEl, backLinkEl;
        
        // Seite initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== PROJECT-SIMPLE.HTML DOMCONTENTLOADED AUSGEF√úHRT ===');
            console.log('=== PROJECT-SIMPLE.HTML INITIALISIERUNG GESTARTET ===');
            console.log('DOM Content Loaded - Starte Initialisierung');
            console.log('Aktuelle URL:', window.location.href);
            console.log('Document ready state:', document.readyState);
            
            // Kleiner Timeout, um sicherzustellen, dass alle anderen Scripts geladen sind
            setTimeout(function() {
                initializeProjectSimple();
            }, 100);
        });
        
        function initializeProjectSimple() {
            console.log('=== INITIALISIERE PROJECT-SIMPLE ===');
            
            // DOM-Elemente nach DOM-Load finden
            pdfContent = document.getElementById('pdf-content');
            exportBtn = document.getElementById('export-btn');
            projectTitleEl = document.getElementById('project-title');
            projectInfoEl = document.getElementById('project-info');
            timeEntriesBodyEl = document.getElementById('time-entries-body');
            constructionImagesEl = document.getElementById('construction-images');
            documentsGalleryEl = document.getElementById('documents-gallery');
            backLinkEl = document.getElementById('back-link');
            
            // Debug: DOM-Elemente pr√ºfen
            console.log('=== DOM-ELEMENTE PR√úFUNG ===');
            console.log('pdfContent:', pdfContent ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('exportBtn:', exportBtn ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('projectTitleEl:', projectTitleEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('projectInfoEl:', projectInfoEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('timeEntriesBodyEl:', timeEntriesBodyEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('constructionImagesEl:', constructionImagesEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('documentsGalleryEl:', documentsGalleryEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('backLinkEl:', backLinkEl ? 'gefunden' : 'NICHT GEFUNDEN');
            
            // Event-Listener f√ºr Export-Button
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function() {
                    console.log('PDF-Export-Button geklickt');
                    generateProjectPDF();
                });
            }
            
            // Projekt-ID aus der URL auslesen
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');
            
            console.log('üîç URL-Parsing:');
            console.log('   - Komplette URL:', window.location.href);
            console.log('   - Search-String:', window.location.search);
            console.log('   - Alle URL-Parameter:', Object.fromEntries(urlParams));
            console.log('   - Extrahierte Projekt-ID:', projectId);
            console.log('   - Projekt-ID Typ:', typeof projectId);
            console.log('   - Projekt-ID L√§nge:', projectId ? projectId.length : 'null');
            
            if (!projectId) {
                console.error('‚ùå FEHLER: Keine Projekt-ID in der URL gefunden.');
                console.log('üí° Erwartete URL-Format: project-simple.html?id=PROJEKT_ID');
                showError('Keine Projekt-ID in der URL gefunden. Bitte w√§hlen Sie ein Projekt von der Hauptseite aus.');
                return;
            }
            
            // TEMP: Firestore-Verbindung testen bevor wir das Projekt laden
            console.log('üß™ Teste Firestore-Verbindung...');
            testFirestoreConnection().then(() => {
                console.log('‚úÖ Firestore-Test abgeschlossen, starte Projekt-Laden...');
            }).catch(error => {
                console.error('‚ùå Firestore-Test fehlgeschlagen:', error);
                showError('Firestore-Verbindung fehlgeschlagen: ' + error.message);
            });
        }
        
        async function testFirestoreConnection() {
            try {
                console.log('üß™ Teste einfache Firestore-Abfrage...');
                
                // Timeout f√ºr den Test hinzuf√ºgen
                const testPromise = DataService.projectsCollection.limit(1).get();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firestore-Test Timeout nach 5s')), 5000)
                );
                
                const testQuery = await Promise.race([testPromise, timeoutPromise]);
                console.log('‚úÖ Firestore-Test erfolgreich, Anzahl Docs:', testQuery.size);
                
                // Nach erfolgreichem Test: Projekt-Laden wird weiter unten zentral gestartet
                console.log('üöÄ Firestore-Test erfolgreich ‚Äì Projekt wird gleich geladen...');
                
                // Die Modal-Funktionen werden automatisch durch time-entry-report.js initialisiert
                // beim DOM-Content-Loaded Event
                
            } catch (testError) {
                console.error('‚ùå Firestore-Test fehlgeschlagen:', testError);
                console.error('‚ùå Fehler-Details:', testError.message);
                
                if (testError.message.includes('Timeout')) {
                    console.error('‚è∞ Firestore h√§ngt - verwende alternative Methode');
                    // Versuche trotzdem das Projekt zu laden
                    console.log('üîÑ Versuche Projekt-Laden trotz Firestore-Test-Timeout...');
                    loadProject();
                } else {
                    throw testError;
                }
            }
            
            // Back-Link aktualisieren
            if (backLinkEl) {
                backLinkEl.href = `admin.html`;
                console.log('Back-Link aktualisiert auf Projekt√ºbersicht');
            }
            
            // Debug-Ausgabe zur Verfolgung
            console.log('=== STARTE LADEN DER PROJEKTDATEN ===');
            console.log('Projekt-ID f√ºr Laden:', projectId);
            
            // Daten laden (einmalig)
            console.log('Rufe loadProject() auf...');
            loadProject().then(() => {
                console.log('loadProject() abgeschlossen');
            }).catch(error => {
                console.error('loadProject() fehlgeschlagen:', error);
                showError('Fehler beim Laden des Projekts: ' + error.message);
            });
        }
        
        // Hilfsfunktion: Fehler anzeigen
        function showError(message) {
            console.error('FEHLER:', message);
            
            // Fehler in allen relevanten Containern anzeigen
            const containers = [
                document.getElementById('project-info'),
                document.getElementById('time-entries-container'),
                document.getElementById('vehicle-usages-container'),
                document.getElementById('construction-images'),
                document.getElementById('documents-gallery')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.innerHTML = `<div style="color: red; padding: 20px; border: 1px solid red; background-color: #ffe6e6; border-radius: 4px;">
                        <strong>Fehler:</strong> ${message}
                    </div>`;
                }
            });
            
            // Auch als Alert anzeigen
            alert('Fehler: ' + message);
        }
        
        // Projekt laden
        async function loadProject() {
            try {
                console.log('üöÄ === PROJEKT LADEN GESTARTET ===');
                console.log('üéØ Versuche Projekt zu laden mit ID:', projectId);
                
                // DataService-Verf√ºgbarkeit pr√ºfen
                if (typeof DataService === 'undefined') {
                    throw new Error('DataService ist nicht verf√ºgbar. Pr√ºfen Sie, ob data.js geladen wurde.');
                }
                console.log('‚úÖ DataService ist verf√ºgbar');
                
                // DataService-Initialisierung pr√ºfen
                console.log('üîß DataService.db verf√ºgbar:', !!DataService.db);
                console.log('üîß DataService.projectsCollection verf√ºgbar:', !!DataService.projectsCollection);
                
                // DataService initialisieren, falls noch nicht geschehen
                if (!DataService.db) {
                    console.log('üîÑ Initialisiere DataService...');
                    await DataService.init();
                    console.log('‚úÖ DataService initialisiert');
                } else {
                    console.log('‚úÖ DataService bereits initialisiert');
                }

                // Admin-Pr√ºfung f√ºr UI-Elemente
                console.log('üîê √úberpr√ºfe Admin-Status f√ºr UI-Steuerung...');
                const isAdmin = await DataService.isAdmin();
                console.log('üîê Admin-Status:', isAdmin);
                console.log('üîê Current User:', DataService.getCurrentUser());
                console.log('üîê Current Admin:', DataService.getCurrentAdmin());
                
                // Body-Klasse f√ºr CSS-basierte Steuerung setzen
                if (!isAdmin) {
                    console.log('üîí Setze employee-mode CSS-Klasse f√ºr normale Mitarbeiter');
                    document.body.classList.add('employee-mode');
                    document.body.classList.remove('admin-mode');
                    window.hideEditButtonsForEmployee = true;
                } else {
                    console.log('‚úÖ Setze admin-mode CSS-Klasse f√ºr Administratoren');
                    document.body.classList.add('admin-mode');
                    document.body.classList.remove('employee-mode');
                    window.hideEditButtonsForEmployee = false;
                }
                
                // Verf√ºgbare Methoden loggen
                console.log('üõ†Ô∏è Verf√ºgbare DataService-Methoden:', 
                    Object.getOwnPropertyNames(DataService)
                        .filter(name => typeof DataService[name] === 'function')
                        .sort()
                );
                
                // Projekt aus der Datenbank laden √ºber DataService
                console.log('üì• Lade Projektdokument √ºber DataService...');
                console.log('üìã Rufe DataService.getProjectById auf mit ID:', projectId);
                
                // Timeout f√ºr den getProjectById Aufruf
                const projectPromise = DataService.getProjectById(projectId);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: getProjectById dauert zu lange (30s)')), 30000)
                );
                
                console.log('‚è±Ô∏è Starte getProjectById mit 30s Timeout...');
                const project = await Promise.race([projectPromise, timeoutPromise]);
                console.log('üì§ DataService.getProjectById Ergebnis:', project);
                console.log('üì§ Projekt-Typ:', typeof project);
                console.log('üì§ Projekt-Keys:', project ? Object.keys(project) : 'null');
                
                if (!project) {
                    console.error('‚ùå Projekt nicht gefunden f√ºr ID:', projectId);
                    console.log('üí° M√∂gliche Ursachen:');
                    console.log('   - Projekt-ID existiert nicht in der Datenbank');
                    console.log('   - Firestore-Verbindungsprobleme');
                    console.log('   - Unzureichende Berechtigung');
                    showError('Projekt nicht gefunden.');
                    return;
                }
                
                console.log('=== PROJEKT ERFOLGREICH GELADEN ===');
                console.log('Projekt-Daten:', project);
                
                // Projektdaten anzeigen
                if (projectTitleEl) {
                    projectTitleEl.textContent = project.name || 'Unbenanntes Projekt';
                    console.log('Projekt-Titel gesetzt:', project.name);
                } else {
                    console.error('projectTitleEl nicht gefunden!');
                }
                
                let infoText = '';
                if (project.client) infoText += `<strong>Kunde:</strong> ${project.client}<br>`;
                if (project.location) infoText += `<strong>Standort:</strong> ${project.location}<br>`;
                if (project.startDate) {
                    const startDate = project.startDate instanceof firebase.firestore.Timestamp ?
                        project.startDate.toDate() : new Date(project.startDate);
                    infoText += `<strong>Startdatum:</strong> ${startDate.toLocaleDateString('de-DE')}<br>`;
                }
                if (project.endDate) {
                    const endDate = project.endDate instanceof firebase.firestore.Timestamp ?
                        project.endDate.toDate() : new Date(project.endDate);
                    infoText += `<strong>Enddatum:</strong> ${endDate.toLocaleDateString('de-DE')}<br>`;
                }
                if (project.description) infoText += `<strong>Beschreibung:</strong> ${project.description}`;
                
                if (projectInfoEl) {
                    projectInfoEl.innerHTML = infoText;
                    console.log('Projekt-Info gesetzt:', infoText);
                } else {
                    console.error('projectInfoEl nicht gefunden!');
                }
                
                // Zeiteintr√§ge, Bilder, Fahrzeugbuchungen und Dokumente laden
                console.log('=== STARTE LADEN DER UNTERGEORDNETEN DATEN ===');
                
                console.log('1. Lade Zeiteintr√§ge...');
                await loadTimeEntries();
                
                console.log('2. Lade Fahrzeugbuchungen...');
                await loadVehicleUsages();
                
                console.log('3. Lade Nachkalkulation...');
                await loadNachkalkulation();

                console.log('4. Lade Baustellenbilder...');
                await loadProjectImages('construction_site');
                
                console.log('5. Lade Dokumente...');
                await loadProjectImages('delivery_note');
                
                console.log('=== ALLE DATEN ERFOLGREICH GELADEN ===');
                
                // Zuklappbare Sections initialisieren (falls noch nicht geschehen)
                if (typeof initCollapsibleSections === 'function') {
                    initCollapsibleSections();
                }
                
                // Event-Listener f√ºr Button zum Hinzuf√ºgen von Fahrzeugbuchungen
                const addVehicleBookingBtn = document.getElementById('add-vehicle-booking-btn');
                if (addVehicleBookingBtn) {
                    // Entferne eventuelle alte Event-Listener
                    const newBtn = addVehicleBookingBtn.cloneNode(true);
                    addVehicleBookingBtn.parentNode.replaceChild(newBtn, addVehicleBookingBtn);
                    // Neuen Event-Listener hinzuf√ºgen
                    newBtn.addEventListener('click', openAddVehicleBookingModal);
                    console.log('Event-Listener f√ºr Fahrzeugbuchungs-Button hinzugef√ºgt');
                } else {
                    console.warn('Button add-vehicle-booking-btn nicht gefunden');
                }
                
                // Report-Button-√úberwachung f√ºr normale Mitarbeiter starten
                if (document.body.classList.contains('employee-mode')) {
                    console.log('üîí Starte Report-Button-√úberwachung f√ºr Mitarbeiter');
                    // Sofortiges Verstecken
                    hideAllReportButtons();
                    // MutationObserver starten
                    startReportButtonObserver();
                    // Periodische √úberwachung alle 2 Sekunden als Backup
                    setInterval(hideAllReportButtons, 2000);
                }
                
            } catch (error) {
                console.error('=== FEHLER BEIM LADEN DES PROJEKTS ===');
                console.error('Fehler-Typ:', error.constructor.name);
                console.error('Fehler-Message:', error.message);
                console.error('Fehler-Stack:', error.stack);
                console.error('Fehler-Objekt:', error);
                
                // Spezielle Behandlung f√ºr verschiedene Fehlertypen
                if (error.message && error.message.includes('Timeout')) {
                    console.error('üïê TIMEOUT-FEHLER: DataService.getProjectById dauert zu lange');
                    showError('Timeout: Das Laden des Projekts dauert zu lange. Bitte pr√ºfen Sie Ihre Internetverbindung.');
                } else if (error.message && error.message.includes('permission')) {
                    console.error('üîí BERECHTIGUNGS-FEHLER: Keine Berechtigung f√ºr Firestore');
                    showError('Berechtigungsfehler: Keine Berechtigung zum Laden des Projekts.');
                } else {
                    console.error('‚ùì UNBEKANNTER FEHLER beim Laden des Projekts');
                    showError('Fehler beim Laden des Projekts: ' + (error.message || 'Unbekannter Fehler'));
                }
            }
        }
        
        // Zeiteintr√§ge laden
        async function loadTimeEntries() {
            try {
                const timeEntriesContainer = document.getElementById('time-entries-container');
                timeEntriesContainer.innerHTML = '<p>Zeiteintr√§ge werden geladen...</p>';
                
                // Zeiteintr√§ge √ºber DataService laden
                const timeEntries = await DataService.getProjectTimeEntries(projectId);
                
                if (!timeEntries || timeEntries.length === 0) {
                    console.log('Keine Zeiteintr√§ge gefunden');
                    timeEntriesContainer.innerHTML = '<p>Keine Zeiteintr√§ge vorhanden.</p>';
                    return;
                }
                
                console.log(`${timeEntries.length} Zeiteintr√§ge gefunden`);
                
                // Nach Datum sortieren (neueste zuerst)
                timeEntries.sort((a, b) => {
                    // Sichere Konvertierung f√ºr verschiedene Timestamp-Formate
                    const getDateFromTimestamp = (timestamp) => {
                        if (!timestamp) return new Date(0);
                        if (timestamp instanceof firebase.firestore.Timestamp) return timestamp.toDate();
                        if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
                        return new Date(timestamp);
                    };
                    
                    // Zuerst clockOutTime pr√ºfen, dann clockInTime
                    const dateA = getDateFromTimestamp(a.clockOutTime || a.clockInTime);
                    const dateB = getDateFromTimestamp(b.clockOutTime || b.clockInTime);
                    
                    return dateB - dateA; // Absteigend (neuste zuerst)
                });
                
                // Mitarbeiterdaten laden
                const employeePromises = timeEntries.map(entry => 
                    entry.employeeId ? DataService.employeesCollection.doc(entry.employeeId).get() : Promise.resolve({ exists: false })
                );
                
                const employeeDocs = await Promise.all(employeePromises);
                const employees = employeeDocs.map(doc => 
                    doc.exists ? { id: doc.id, ...doc.data() } : { name: 'Unbekannt' }
                );
                
                // Zeiteintr√§ge anzeigen
                timeEntriesContainer.innerHTML = `
                    <table id="time-entries-table" class="time-entries">
                        <thead>
                            <tr>
                                <th>Bearbeitung</th>
                                <th>Mitarbeiter</th>
                                <th>Datum</th>
                                <th>Einstempelzeit</th>
                                <th>Ausstempelzeit</th>
                                <th>Arbeitszeit</th>
                                <th>L√∂schen</th>
                            </tr>
                        </thead>
                        <tbody id="time-entries-body"></tbody>
                    </table>
                `;
                
                const tableBody = document.getElementById('time-entries-body');
                
                timeEntries.forEach((entry, index) => {
                    const employee = employees[index] || { name: 'Unbekannt' };
                    
                    // Datum formatieren
                    let date = 'Unbekannt';
                    let clockInTime = '-';
                    let clockOutTime = '-';
                    let workHours = '-';
                    
                    // Hilfsfunktion zum Sicheren Konvertieren von Zeitstempeln
                    function safelyConvertTimestamp(timestamp) {
                        if (!timestamp) return null;
                        
                        try {
                            // Firestore Timestamp konvertieren
                            if (timestamp instanceof firebase.firestore.Timestamp) {
                                return timestamp.toDate();
                            }
                            
                            // Unix-Timestamp als Nummer (Sekunden)
                            if (typeof timestamp === 'number') {
                                return new Date(timestamp * 1000);
                            }
                            
                            // Unix-Timestamp als String (Millisekunden)
                            if (typeof timestamp === 'string' && !isNaN(timestamp)) {
                                return new Date(parseInt(timestamp));
                            }
                            
                            // ISO-Datumsstring
                            if (typeof timestamp === 'string') {
                                const d = new Date(timestamp);
                                return isNaN(d.getTime()) ? null : d;
                            }
                            
                            // Date-Objekt
                            if (timestamp instanceof Date) {
                                return timestamp;
                            }
                            
                            // Firestore Servervalue-Timestamp-Objekt
                            if (timestamp && timestamp._seconds) {
                                return new Date(timestamp._seconds * 1000);
                            }
                            
                            return null;
                        } catch (e) {
                            console.error('Fehler bei der Zeitkonvertierung:', e, timestamp);
                            return null;
                        }
                    }
                    
                    // Einstempelzeit konvertieren und formatieren
                    const clockInDateObj = safelyConvertTimestamp(entry.clockInTime);
                    if (clockInDateObj) {
                        date = clockInDateObj.toLocaleDateString('de-DE');
                        clockInTime = clockInDateObj.toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    
                    // Ausstempelzeit konvertieren und formatieren
                    if (entry.clockOutTime) {
                        const clockOutDateObj = safelyConvertTimestamp(entry.clockOutTime);
                        if (clockOutDateObj) {
                            clockOutTime = clockOutDateObj.toLocaleTimeString('de-DE', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            
                            // Arbeitszeit berechnen, wenn beide Zeitstempel g√ºltig sind
                            if (clockInDateObj) {
                                const pauseTotalTime = entry.pauseTotalTime || 0;
                                const totalTimeMs = clockOutDateObj.getTime() - clockInDateObj.getTime();
                                const actualWorkTimeMs = totalTimeMs - pauseTotalTime;
                                
                                if (actualWorkTimeMs > 0) {
                                    const totalMinutes = Math.floor(actualWorkTimeMs / 60000);
                                    const hours = Math.floor(totalMinutes / 60);
                                    const minutes = totalMinutes % 60;
                                    workHours = `${hours}h ${minutes}min`;
                                } else if (entry.isVacationDay) {
                                    // Urlaubstag: 0 Stunden, aber erkennbar markieren
                                    workHours = '0h (Urlaub)';
                                }
                            }
                        }
                    }
                    
                    // Zeile zur Tabelle hinzuf√ºgen
                    const row = document.createElement('tr');
                    row.setAttribute('data-entry-id', entry.id); // Zeile selbst bekommt auch die ID
                    
                    // Edit-Button nur f√ºr Admins anzeigen
                    const editButtonHtml = window.hideEditButtonsForEmployee ? '' : `
                        <button class="btn small-btn edit-entry-btn" data-entry-id="${entry.id}" title="Zeiteintrag bearbeiten" onclick="openEditTimeEntryModal('${entry.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                    
                    // L√∂schen-Button nur f√ºr Admins anzeigen (separate Spalte)
                    const deleteButtonHtml = window.hideEditButtonsForEmployee ? '' : `
                        <button class="btn small-btn delete-entry-btn" data-entry-id="${entry.id}" title="Zeiteintrag l√∂schen" onclick="deleteTimeEntry('${entry.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    
                    row.innerHTML = `
                        <td>
                            ${editButtonHtml}
                        </td>
                        <td>${employee.name}</td>
                        <td>${date}</td>
                        <td>${clockInTime}</td>
                        <td>${clockOutTime}</td>
                        <td>${workHours}</td>
                        <td>
                            ${deleteButtonHtml}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                console.log(`${timeEntries.length} Zeiteintr√§ge angezeigt`);
                
                // Report-Buttons f√ºr Mitarbeiter verstecken (zus√§tzliche Sicherheit)
                if (document.body.classList.contains('employee-mode')) {
                    setTimeout(hideAllReportButtons, 100);
                }
                
            } catch (error) {
                console.error('Fehler beim Laden der Zeiteintr√§ge:', error);
                const timeEntriesContainer = document.getElementById('time-entries-container');
                timeEntriesContainer.innerHTML = '<p class="error">Fehler beim Laden der Zeiteintr√§ge.</p>';
            }
        }

        // Funktion zum Verstecken aller Report-Buttons f√ºr normale Mitarbeiter
        function hideAllReportButtons() {
            if (!document.body.classList.contains('employee-mode')) {
                return; // Nur f√ºr normale Mitarbeiter ausf√ºhren
            }
            
            console.log('üîí Verstecke alle Report-Buttons f√ºr normale Mitarbeiter');
            
            // Alle m√∂glichen Report-Button Selektoren
            const reportButtonSelectors = [
                '.report-btn',
                '.report-button',
                'button[class*="report"]',
                'button[title*="Bericht"]',
                'button[title*="Report"]',
                '.btn[onclick*="report"]',
                '.btn[onclick*="Report"]'
            ];
            
            let hiddenCount = 0;
            reportButtonSelectors.forEach(selector => {
                const buttons = document.querySelectorAll(selector);
                buttons.forEach(button => {
                    if (button.style.display !== 'none') {
                        button.style.display = 'none';
                        hiddenCount++;
                        console.log('üîí Report-Button versteckt:', button);
                    }
                });
            });
            
            // Zus√§tzlich: alle Buttons in der Bearbeitungs-Spalte pr√ºfen
            const editCells = document.querySelectorAll('#time-entries-table td:first-child');
            editCells.forEach(cell => {
                const reportButtons = cell.querySelectorAll('button:not(.edit-entry-btn):not(.delete-entry-btn)');
                reportButtons.forEach(button => {
                    if (button.textContent.toLowerCase().includes('bericht') || 
                        button.textContent.toLowerCase().includes('report')) {
                        if (button.style.display !== 'none') {
                            button.style.display = 'none';
                            hiddenCount++;
                            console.log('üîí Report-Button in Edit-Zelle versteckt:', button);
                        }
                    }
                });
            });
            
            if (hiddenCount > 0) {
                console.log(`üîí ${hiddenCount} Report-Buttons versteckt`);
            }
        }

        // MutationObserver f√ºr das √úberwachen neuer Report-Buttons
        function startReportButtonObserver() {
            if (!document.body.classList.contains('employee-mode')) {
                return; // Nur f√ºr normale Mitarbeiter
            }
            
            console.log('üîç Starte MutationObserver f√ºr Report-Buttons');
            
            const observer = new MutationObserver(function(mutations) {
                let shouldHide = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                // Pr√ºfe, ob der neue Node oder seine Kinder Report-Buttons sind
                                if (node.classList && (node.classList.contains('report-btn') || node.classList.contains('report-button'))) {
                                    shouldHide = true;
                                } else if (node.querySelectorAll) {
                                    const reportButtons = node.querySelectorAll('.report-btn, .report-button, button[class*="report"]');
                                    if (reportButtons.length > 0) {
                                        shouldHide = true;
                                    }
                                }
                            }
                        });
                    }
                });
                
                if (shouldHide) {
                    console.log('üîç Neue Report-Buttons erkannt, verstecke sie');
                    setTimeout(hideAllReportButtons, 10); // Kurze Verz√∂gerung
                }
            });
            
            // √úberwache die gesamte Tabelle und Admin-Controls
            const tableContainer = document.getElementById('time-entries-container');
            if (tableContainer) {
                observer.observe(tableContainer, {
                    childList: true,
                    subtree: true,
                    attributes: false
                });
            }
            
            const adminControls = document.querySelectorAll('.admin-controls');
            adminControls.forEach(control => {
                observer.observe(control, {
                    childList: true,
                    subtree: true,
                    attributes: false
                });
            });
        }
        
        // Bilder laden
        // Fahrzeugbuchungen laden (Stunden-basiert)
        async function loadVehicleUsages() {
            try {
                const vehicleUsagesContainer = document.getElementById('vehicle-usages-container');
                vehicleUsagesContainer.innerHTML = '<p>Fahrzeugbuchungen werden geladen...</p>';
                
                // Fahrzeugbuchungen √ºber DataService laden - verwende getVehicleUsagesForProject wie in der Nachkalkulation
                // und filtere dann nach direkten Buchungen
                const allBookings = await DataService.getVehicleUsagesForProject(projectId);
                console.log(`Alle Fahrzeugbuchungen geladen: ${allBookings.length}`);
                
                // Nur direkte Buchungen anzeigen (isDirectBooking === true)
                const directBookings = allBookings.filter(booking => booking.isDirectBooking === true);
                console.log(`Direkte Fahrzeugbuchungen: ${directBookings.length}`);
                
                const employees = await DataService.getAllActiveEmployees();
                const vehicles = await DataService.getAllVehicles();
                
                // Maps f√ºr schnellen Zugriff
                const employeeMap = {};
                employees.forEach(emp => employeeMap[emp.id] = emp);
                
                const vehicleMap = {};
                vehicles.forEach(veh => vehicleMap[veh.id] = veh);
                
                if (!directBookings || directBookings.length === 0) {
                    console.log('Keine direkten Fahrzeugbuchungen gefunden');
                    vehicleUsagesContainer.innerHTML = '<p>Keine Fahrzeugbuchungen vorhanden.</p>';
                    return;
                }
                
                console.log(`${directBookings.length} Fahrzeugbuchungen gefunden`);
                
                // Nach Datum sortieren (neueste zuerst)
                directBookings.sort((a, b) => {
                    const getDateFromTimestamp = (timestamp) => {
                        if (!timestamp) return new Date(0);
                        // Firestore Timestamp
                        if (timestamp instanceof firebase.firestore.Timestamp) return timestamp.toDate();
                        if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
                        // String im Format YYYY-MM-DD
                        if (typeof timestamp === 'string') {
                            // Pr√ºfe ob es ein ISO-String ist oder YYYY-MM-DD Format
                            if (timestamp.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                return new Date(timestamp + 'T00:00:00');
                            }
                            return new Date(timestamp);
                        }
                        // Date-Objekt
                        if (timestamp instanceof Date) return timestamp;
                        // Fallback
                        return new Date(timestamp);
                    };
                    
                    const dateA = getDateFromTimestamp(a.date);
                    const dateB = getDateFromTimestamp(b.date);
                    
                    return dateB.getTime() - dateA.getTime(); // Absteigend (neueste zuerst)
                });
                
                // Tabelle mit Fahrzeugbuchungen erstellen
                vehicleUsagesContainer.innerHTML = `
                    <table id="vehicle-usages-table" class="data-table">
                        <thead>
                            <tr>
                                <th>Fahrzeug</th>
                                <th>Mitarbeiter</th>
                                <th>Datum</th>
                                <th>Stunden</th>
                                <th>Kommentar</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="vehicle-usages-body"></tbody>
                    </table>
                `;
                
                const tableBody = document.getElementById('vehicle-usages-body');
                
                directBookings.forEach((booking) => {
                    const employee = employeeMap[booking.employeeId] || { name: 'Unbekannt' };
                    const vehicle = vehicleMap[booking.vehicleId] || { name: 'Unbekanntes Fahrzeug' };
                    
                    // Datum formatieren
                    let dateStr = 'Unbekannt';
                    if (booking.date) {
                        let dateObj;
                        if (booking.date instanceof firebase.firestore.Timestamp) {
                            dateObj = booking.date.toDate();
                        } else if (typeof booking.date === 'string') {
                            // String im Format YYYY-MM-DD
                            if (booking.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                dateObj = new Date(booking.date + 'T00:00:00');
                            } else {
                                dateObj = new Date(booking.date);
                            }
                        } else if (booking.date instanceof Date) {
                            dateObj = booking.date;
                        } else if (booking.date.seconds) {
                            dateObj = new Date(booking.date.seconds * 1000);
                        } else {
                            dateObj = new Date(booking.date);
                        }
                        dateStr = dateObj.toLocaleDateString('de-DE');
                    }
                    
                    // Stunden formatieren
                    const hours = booking.hours || booking.hoursUsed || 0;
                    const hoursStr = typeof hours === 'number' ? hours.toFixed(2) + ' h' : hours;
                    
                    // Kommentar formatieren
                    const comment = booking.comment || '-';
                    
                    // Zeile erstellen
                    const row = document.createElement('tr');
                    
                    // Edit-Button nur f√ºr Admins anzeigen
                    const deleteButtonHtml = window.hideEditButtonsForEmployee ? '' : `
                        <button class="action-btn delete-btn" onclick="deleteVehicleBookingSimple('${booking.id}')" title="L√∂schen">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    row.innerHTML = `
                        <td>${vehicle.name}</td>
                        <td>${employee.name}</td>
                        <td>${dateStr}</td>
                        <td>${hoursStr}</td>
                        <td>${comment}</td>
                        <td>${deleteButtonHtml}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                console.log(`${directBookings.length} Fahrzeugbuchungen angezeigt`);
                
            } catch (error) {
                console.error('Fehler beim Laden der Fahrzeugbuchungen:', error);
                const vehicleUsagesContainer = document.getElementById('vehicle-usages-container');
                if (vehicleUsagesContainer) {
                    vehicleUsagesContainer.innerHTML = '<p class="error">Fehler beim Laden der Fahrzeugbuchungen.</p>';
                }
            }
        }
        
        // Fahrzeugbuchung l√∂schen
        async function deleteVehicleBookingSimple(bookingId) {
            if (!confirm('M√∂chten Sie diese Fahrzeugbuchung wirklich l√∂schen?')) {
                return;
            }
            
            try {
                await DataService.vehicleUsagesCollection.doc(bookingId).delete();
                if (typeof showNotification === 'function') {
                    showNotification('Fahrzeugbuchung erfolgreich gel√∂scht', 'success');
                } else {
                    alert('Fahrzeugbuchung erfolgreich gel√∂scht');
                }
                await loadVehicleUsages();
            } catch (error) {
                console.error('Fehler beim L√∂schen der Fahrzeugbuchung:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Fehler beim L√∂schen der Fahrzeugbuchung', 'error');
                } else {
                    alert('Fehler beim L√∂schen der Fahrzeugbuchung');
                }
            }
        }
        
        // Modal zum Hinzuf√ºgen von Fahrzeugbuchungen √∂ffnen
        async function openAddVehicleBookingModal() {
            console.log('√ñffne Modal zum Hinzuf√ºgen von Fahrzeugbuchungen');
            let modal = document.getElementById('add-vehicle-booking-modal');
            
            if (!modal) {
                // Modal erstellen
                modal = document.createElement('div');
                modal.id = 'add-vehicle-booking-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Fahrzeugbuchung hinzuf√ºgen</h3>
                            <button type="button" class="close-modal-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="add-vehicle-booking-form">
                                <div class="form-group">
                                    <label for="vb-employee-select">Mitarbeiter:</label>
                                    <select id="vb-employee-select" required>
                                        <option value="">-- Mitarbeiter ausw√§hlen --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vb-vehicle-select">Fahrzeug:</label>
                                    <select id="vb-vehicle-select" required>
                                        <option value="">-- Fahrzeug ausw√§hlen --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="vb-date">Datum:</label>
                                    <input type="date" id="vb-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="vb-hours">Stunden:</label>
                                    <input type="number" id="vb-hours" min="0" step="0.25" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="vb-comment">Kommentar (optional):</label>
                                    <textarea id="vb-comment" rows="3"></textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="closeAddVehicleBookingModal()">Abbrechen</button>
                                    <button type="submit" class="btn btn-primary">Speichern</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Event-Listener hinzuf√ºgen
                modal.querySelector('.close-modal-btn').addEventListener('click', closeAddVehicleBookingModal);
                modal.querySelector('#add-vehicle-booking-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveVehicleBooking();
                });
                
                // Modal schlie√üen bei Klick au√üerhalb
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAddVehicleBookingModal();
                    }
                });
            }
            
            // Mitarbeiter und Fahrzeuge laden
            await loadVehicleBookingEmployees();
            await loadVehicleBookingVehicles();
            
            // Aktuelles Datum vorausf√ºllen
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('vb-date').value = today;
            
            // Modal anzeigen
            modal.style.display = 'block';
        }
        
        // Modal schlie√üen (global verf√ºgbar f√ºr onclick)
        window.closeAddVehicleBookingModal = function() {
            const modal = document.getElementById('add-vehicle-booking-modal');
            if (modal) {
                modal.style.display = 'none';
                const form = document.getElementById('add-vehicle-booking-form');
                if (form) form.reset();
            }
        }
        
        // Mitarbeiter f√ºr Fahrzeugbuchung laden
        async function loadVehicleBookingEmployees() {
            const select = document.getElementById('vb-employee-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Mitarbeiter ausw√§hlen --</option>';
            
            const employees = await DataService.getAllActiveEmployees();
            employees.sort((a, b) => a.name.localeCompare(b.name));
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }
        
        // Fahrzeuge f√ºr Fahrzeugbuchung laden
        async function loadVehicleBookingVehicles() {
            const select = document.getElementById('vb-vehicle-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Fahrzeug ausw√§hlen --</option>';
            
            const vehicles = await DataService.getAllVehicles();
            vehicles.sort((a, b) => a.name.localeCompare(b.name));
            
            vehicles.forEach(veh => {
                const option = document.createElement('option');
                option.value = veh.id;
                option.textContent = veh.name;
                select.appendChild(option);
            });
        }
        
        // Fahrzeugbuchung speichern
        async function saveVehicleBooking() {
            try {
                const employeeId = document.getElementById('vb-employee-select').value;
                const vehicleId = document.getElementById('vb-vehicle-select').value;
                const date = document.getElementById('vb-date').value;
                const hours = parseFloat(document.getElementById('vb-hours').value);
                const comment = document.getElementById('vb-comment').value;
                
                if (!employeeId || !vehicleId || !date || !hours) {
                    if (typeof showNotification === 'function') {
                        showNotification('Bitte alle Pflichtfelder ausf√ºllen', 'error');
                    } else {
                        alert('Bitte alle Pflichtfelder ausf√ºllen');
                    }
                    return;
                }
                
                // Fahrzeugbuchung erstellen
                const bookingData = {
                    vehicleId,
                    projectId: projectId,
                    employeeId,
                    hours,
                    date: new Date(date).toISOString().split('T')[0],
                    comment: comment || '',
                    isDirectBooking: true
                };
                
                await DataService.createVehicleTimeBooking(bookingData);
                
                if (typeof showNotification === 'function') {
                    showNotification('Fahrzeugbuchung erfolgreich hinzugef√ºgt', 'success');
                } else {
                    alert('Fahrzeugbuchung erfolgreich hinzugef√ºgt');
                }
                
                closeAddVehicleBookingModal();
                await loadVehicleUsages();
                
            } catch (error) {
                console.error('Fehler beim Speichern der Fahrzeugbuchung:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Fehler beim Speichern der Fahrzeugbuchung: ' + error.message, 'error');
                } else {
                    alert('Fehler beim Speichern der Fahrzeugbuchung: ' + error.message);
                }
            }
        }

        // Nachkalkulation laden
        async function loadNachkalkulation() {
            try {
                console.log('Starte Laden der Nachkalkulation...');
                const nachkalkulationContainer = document.getElementById('nachkalkulation-container');
                
                if (!nachkalkulationContainer) {
                    console.error('Nachkalkulation-Container nicht gefunden');
                    return;
                }
                
                // Nur f√ºr Admins anzeigen
                const currentAdmin = DataService.getCurrentAdmin();
                if (!currentAdmin) {
                    nachkalkulationContainer.innerHTML = '<p>Nachkalkulation nur f√ºr Administratoren verf√ºgbar.</p>';
                    return;
                }
                
                // Nachkalkulation f√ºr das aktuelle Projekt laden
                loadNachkalkulationData(projectId);
                
            } catch (error) {
                console.error('Fehler beim Laden der Nachkalkulation:', error);
                const nachkalkulationContainer = document.getElementById('nachkalkulation-container');
                if (nachkalkulationContainer) {
                    nachkalkulationContainer.innerHTML = `<p>Fehler beim Laden der Nachkalkulation: ${error.message}</p>`;
                }
            }
        }
        
        // Nachkalkulationsdaten f√ºr ein bestimmtes Projekt laden
        async function loadNachkalkulationData(targetProjectId) {
            try {
                console.log(`Lade Nachkalkulationsdaten f√ºr Projekt: ${targetProjectId}`);
                const nachkalkulationContent = document.getElementById('nachkalkulation-content');
                nachkalkulationContent.innerHTML = '<p>Daten werden berechnet...</p>';
                
                // Projektdaten laden
                const project = await DataService.getProjectById(targetProjectId);
                if (!project) {
                    throw new Error('Projekt nicht gefunden');
                }
                
                // 1. Mitarbeiterdaten sammeln
                const timeEntries = await DataService.getProjectTimeEntries(targetProjectId);
                const employeeData = {};
                
                // Zeiten pro Mitarbeiter zusammenfassen
                for (const entry of timeEntries) {
                    if (!entry.employeeId) continue;
                    
                    // Arbeitszeit berechnen
                    let workHours = 0;
                    if (entry.clockInTime && entry.clockOutTime && !entry.isVacationDay) {
                        // Urlaubstage werden √ºbersprungen (0 Stunden)
                        const inTime = entry.clockInTime instanceof firebase.firestore.Timestamp ? 
                            entry.clockInTime.toDate() : new Date(entry.clockInTime);
                        
                        const outTime = entry.clockOutTime instanceof firebase.firestore.Timestamp ? 
                            entry.clockOutTime.toDate() : new Date(entry.clockOutTime);
                        
                        // Berechne die Arbeitsstunden als Differenz, ber√ºcksichtige Pause
                        // pauseTotalTime ist in Millisekunden, pauseMinutes in Minuten (Legacy)
                        const pauseTotalTimeMs = entry.pauseTotalTime || 0;
                        const pauseMinutes = entry.pauseMinutes || 0;
                        const pauseMs = pauseTotalTimeMs || (pauseMinutes * 60 * 1000);
                        
                        const diffMs = outTime.getTime() - inTime.getTime();
                        const actualWorkMs = diffMs - pauseMs;
                        workHours = actualWorkMs / (1000 * 60 * 60); // Millisekunden in Stunden
                        
                        if (workHours < 0) workHours = 0; // Negativ verhindern
                    }
                    // F√ºr Urlaubstage bleibt workHours = 0
                    
                    // Mitarbeiterdaten abrufen, falls nicht vorhanden
                    if (!employeeData[entry.employeeId]) {
                        const employeeDoc = await DataService.employeesCollection.doc(entry.employeeId).get();
                        if (employeeDoc.exists) {
                            const employee = { id: employeeDoc.id, ...employeeDoc.data() };
                            employeeData[entry.employeeId] = {
                                name: employee.name || 'Unbekannt',
                                hourlyRate: employee.hourlyRate || 0,
                                totalHours: 0,
                                totalCost: 0
                            };
                        } else {
                            employeeData[entry.employeeId] = {
                                name: 'Unbekannter Mitarbeiter',
                                hourlyRate: 0,
                                totalHours: 0,
                                totalCost: 0
                            };
                        }
                    }
                    
                    // Stunden aufaddieren
                    employeeData[entry.employeeId].totalHours += workHours;
                }
                
                // Kosten f√ºr jeden Mitarbeiter berechnen
                let totalEmployeeCost = 0;
                for (const employeeId in employeeData) {
                    const employee = employeeData[employeeId];
                    employee.totalCost = employee.hourlyRate * employee.totalHours;
                    totalEmployeeCost += employee.totalCost;
                }
                
                // 2. Fahrzeugdaten sammeln
                const vehicleUsages = await DataService.getVehicleUsagesForProject(targetProjectId);
                const vehicleData = {};
                
                console.log('üöó Gefundene Fahrzeugbuchungen:', vehicleUsages.length);
                console.log('üöó Fahrzeugbuchungen Details:', vehicleUsages);
                
                // Stunden pro Fahrzeug zusammenfassen (aus tats√§chlichen Betriebsstunden)
                for (const usage of vehicleUsages) {
                    if (!usage.vehicleId) continue;
                    
                    // Fahrzeugdaten abrufen, falls nicht vorhanden
                    if (!vehicleData[usage.vehicleId]) {
                        const vehicleDoc = await DataService.vehiclesCollection.doc(usage.vehicleId).get();
                        if (vehicleDoc.exists) {
                            const vehicle = { id: vehicleDoc.id, ...vehicleDoc.data() };
                            vehicleData[usage.vehicleId] = {
                                name: vehicle.name || 'Unbekannt',
                                hourlyRate: vehicle.hourlyRate || 0,
                                totalHours: 0,
                                totalCost: 0
                            };
                        } else {
                            vehicleData[usage.vehicleId] = {
                                name: 'Unbekanntes Fahrzeug',
                                hourlyRate: 0,
                                totalHours: 0,
                                totalCost: 0
                            };
                        }
                    }
                    
                    // Tats√§chliche Betriebsstunden aus der Fahrzeugbuchung verwenden
                    // Das Feld 'hours' aus der Fahrzeugbuchung enth√§lt die tats√§chlichen Stunden
                    const usageHours = usage.hours || 0;
                    
                    if (usageHours > 0) {
                        // Stunden aufaddieren
                        vehicleData[usage.vehicleId].totalHours += usageHours;
                        console.log(`F√ºge ${usageHours}h f√ºr Fahrzeug ${vehicleData[usage.vehicleId].name} hinzu. Gesamt: ${vehicleData[usage.vehicleId].totalHours}h`);
                    }
                }
                
                // Kosten f√ºr jedes Fahrzeug berechnen
                let totalVehicleCost = 0;
                for (const vehicleId in vehicleData) {
                    const vehicle = vehicleData[vehicleId];
                    vehicle.totalCost = vehicle.hourlyRate * vehicle.totalHours;
                    totalVehicleCost += vehicle.totalCost;
                }
                
                // 3. Gesamtkosten berechnen
                const totalProjectCost = totalEmployeeCost + totalVehicleCost;
                
                // 4. Daten f√ºr die Anzeige aufbereiten und anzeigen
                displayNachkalkulation(employeeData, vehicleData, totalEmployeeCost, totalVehicleCost, totalProjectCost);
                
            } catch (error) {
                console.error('Fehler beim Berechnen der Nachkalkulation:', error);
                const nachkalkulationContent = document.getElementById('nachkalkulation-content');
                if (nachkalkulationContent) {
                    nachkalkulationContent.innerHTML = `<p>Fehler beim Berechnen der Nachkalkulation: ${error.message}</p>`;
                }
            }
        }
        
        // Nachkalkulation im UI anzeigen
        function displayNachkalkulation(employeeData, vehicleData, totalEmployeeCost, totalVehicleCost, totalProjectCost) {
            const nachkalkulationContent = document.getElementById('nachkalkulation-content');
            if (!nachkalkulationContent) return;
            
            // Formatieren f√ºr Euro-Darstellung
            function formatCurrency(amount) {
                return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
            }
            
            // Formatieren f√ºr Stundenangabe
            function formatHours(hours) {
                return parseFloat(hours.toFixed(2)).toLocaleString('de-DE') + ' h';
            }
            
            // HTML f√ºr die Ausgabe erstellen
            let html = `
                <h3>Personalkosten:</h3>
                <table class="nachkalkulation-table">
                    <thead>
                        <tr>
                            <th>Mitarbeiter</th>
                            <th>Stunden</th>
                            <th>Stundensatz</th>
                            <th>Summe</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Mitarbeiterdaten einf√ºgen
            const employees = Object.values(employeeData);
            if (employees.length > 0) {
                employees.forEach(employee => {
                    html += `
                        <tr>
                            <td>${employee.name}</td>
                            <td>${formatHours(employee.totalHours)}</td>
                            <td>${formatCurrency(employee.hourlyRate)}</td>
                            <td>${formatCurrency(employee.totalCost)}</td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="4">Keine Mitarbeiterdaten verf√ºgbar</td>
                    </tr>
                `;
            }
            
            // Summenzeile f√ºr Personal
            html += `
                <tr class="total-row">
                    <td colspan="3">Summe Personalkosten</td>
                    <td>${formatCurrency(totalEmployeeCost)}</td>
                </tr>
            </tbody>
            </table>
            
            <h3>Fahrzeugkosten:</h3>
            <table class="nachkalkulation-table">
                <thead>
                    <tr>
                        <th>Fahrzeug</th>
                        <th>Stunden</th>
                        <th>Stundensatz</th>
                        <th>Summe</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Fahrzeugdaten einf√ºgen
            const vehicles = Object.values(vehicleData);
            if (vehicles.length > 0) {
                vehicles.forEach(vehicle => {
                    html += `
                        <tr>
                            <td>${vehicle.name}</td>
                            <td>${formatHours(vehicle.totalHours)}</td>
                            <td>${formatCurrency(vehicle.hourlyRate)}</td>
                            <td>${formatCurrency(vehicle.totalCost)}</td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="4">Keine Fahrzeugdaten verf√ºgbar</td>
                    </tr>
                `;
            }
            
            // Summenzeile f√ºr Fahrzeuge
            html += `
                <tr class="total-row">
                    <td colspan="3">Summe Fahrzeugkosten</td>
                    <td>${formatCurrency(totalVehicleCost)}</td>
                </tr>
            </tbody>
            </table>
            
            <h3>Gesamtkosten:</h3>
            <table class="nachkalkulation-table">
                <tbody>
                    <tr class="grand-total-row">
                        <td colspan="3">GESAMTKOSTEN PROJEKT</td>
                        <td>${formatCurrency(totalProjectCost)}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            nachkalkulationContent.innerHTML = html;
        }
        
        async function loadProjectImages(type) {
            try {
                console.log(`=== LADE ${type.toUpperCase()}-BILDER ===`);
                console.log(`Lade ${type}-Bilder f√ºr Projekt:`, projectId);
                const containerId = type === 'construction_site' ? 'construction-images' : 'documents-gallery';
                
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container mit ID ${containerId} nicht gefunden`);
                    return;
                }
                
                // Container leeren und Ladeindikator anzeigen
                container.innerHTML = `<p>${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'} werden geladen...</p>`;
                
                // Dateien direkt f√ºr den gew√ºnschten Typ laden (robuster, keine Abh√§ngigkeit von Cache)
                let files = [];
                try {
                    files = await DataService.getProjectFiles(projectId, type);
                    // Falls es sich um Dokumente handelt, zus√§tzlich auch 'invoice' laden und zusammenf√ºhren
                    if (type === 'delivery_note') {
                        const invoiceFiles = await DataService.getProjectFiles(projectId, 'invoice');
                        files = [...files, ...invoiceFiles];
                    }
                } catch (e) {
                    console.error('Fehler beim Laden der Dateien:', e);
                    files = [];
                }

                // Deduplizieren nach id/url/Dateiattributen
                const seen = new Set();
                const deduped = [];
                for (const f of files) {
                    const key = f.id || f.url || `${f.fileName}|${f.fileSize}|${f.employeeId}|${f.projectId}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        deduped.push(f);
                    }
                }
                files = deduped;

                console.log(`Anzahl ${type}-Dateien gefunden:`, files.length);
                
                if (!files || files.length === 0) {
                    console.log(`Keine ${type}-Bilder gefunden`);
                    container.innerHTML = `<p>Keine ${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'} vorhanden.</p>`;
                    return;
                }
                
                console.log(`${files.length} ${type}-Bilder/Dokumente werden angezeigt`);
                
                // Container leeren
                container.innerHTML = '';
                
                // Z√§hler f√ºr geladene Bilder (f√ºr Initialisierung der Lightbox)
                let loadedImages = 0;
                const totalImages = files.length;
                
                // Bilder zur Galerie hinzuf√ºgen
                for (let index = 0; index < files.length; index++) {
                    const file = files[index];
                    console.log(`Verarbeite Datei ${index + 1}/${files.length}:`, file);
                    
                    // Mitarbeiterinformationen abrufen (wenn vorhanden)
                    let employeeName = 'Unbekannt';
                    if (file.employeeId) {
                        try {
                            const employeeDoc = await DataService.employeesCollection.doc(file.employeeId).get();
                            if (employeeDoc.exists) {
                                employeeName = employeeDoc.data().name || 'Unbekannt';
                            }
                        } catch (error) {
                            console.warn('Fehler beim Laden des Mitarbeiters:', error);
                        }
                    }
                    
                    // Datum formatieren mit sicherer Konvertierungsfunktion
                    let formattedDate = 'Unbekanntes Datum';
                    
                    // Hilfsfunktion zum Sicheren Konvertieren von Zeitstempeln
                    function safelyConvertTimestamp(timestamp) {
                        if (!timestamp) return null;
                        
                        try {
                            // Firestore Timestamp konvertieren
                            if (timestamp instanceof firebase.firestore.Timestamp) {
                                return timestamp.toDate();
                            }
                            
                            // Unix-Timestamp als Nummer (Sekunden)
                            if (typeof timestamp === 'number') {
                                return new Date(timestamp * 1000);
                            }
                            
                            // Unix-Timestamp als String (Millisekunden)
                            if (typeof timestamp === 'string' && !isNaN(timestamp)) {
                                return new Date(parseInt(timestamp));
                            }
                            
                            // ISO-Datumsstring
                            if (typeof timestamp === 'string') {
                                const d = new Date(timestamp);
                                return isNaN(d.getTime()) ? null : d;
                            }
                            
                            // Date-Objekt
                            if (timestamp instanceof Date) {
                                return timestamp;
                            }
                            
                            // Firestore Servervalue-Timestamp-Objekt
                            if (timestamp && timestamp._seconds) {
                                return new Date(timestamp._seconds * 1000);
                            }
                            
                            return null;
                        } catch (e) {
                            console.error('Fehler bei der Zeitkonvertierung:', e, timestamp);
                            return null;
                        }
                    }
                    
                    // Versuche verschiedene Zeitstempel-Eigenschaften
                    let dateObj = null;
                    
                    if (file.timestamp) {
                        dateObj = safelyConvertTimestamp(file.timestamp);
                    } 
                    
                    if (!dateObj && file.uploadDate) {
                        dateObj = safelyConvertTimestamp(file.uploadDate);
                    }
                    
                    if (!dateObj && file.uploadTime) {
                        dateObj = safelyConvertTimestamp(file.uploadTime);
                    }
                    
                    if (dateObj) {
                        formattedDate = dateObj.toLocaleDateString('de-DE');
                    }
                    
                    // Galerie-Element erstellen
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    // Bild-Element erstellen
                    const img = document.createElement('img');
                    img.className = 'gallery-img';
                    // Fallback: Wenn keine URL vorhanden ist, aber Base64 vorliegt, diese zusammensetzen
                    const fallbackDataUrl = (file.base64String && file.mimeType) ? `${file.mimeType},${file.base64String}` : '';
                    img.src = file.url || file.downloadURL || fallbackDataUrl || '';
                    img.alt = type === 'construction_site' ? 'Baustellenfoto' : 'Dokument';
                    
                    // Bild-Lade√ºberwachung f√ºr Lightbox-Initialisierung
                    img.onload = function() {
                        loadedImages++;
                        console.log(`Bild ${loadedImages}/${totalImages} geladen`);
                        // Initialisiere Lightbox, wenn alle Bilder geladen sind
                        if (loadedImages === totalImages) {
                            console.log('Alle Bilder geladen, initialisiere Lightbox');
                            initializeLightboxAfterLoad();
                        }
                    };
                    
                    img.onerror = function() {
                        loadedImages++;
                        console.error('Fehler beim Laden des Bildes:', file.url || file.downloadURL);
                        // Selbst bei Fehler √ºberpr√ºfen, ob wir mit der Initialisierung fortfahren k√∂nnen
                        if (loadedImages === totalImages) {
                            console.log('Alle Bilder verarbeitet (mit Fehlern), initialisiere Lightbox');
                            initializeLightboxAfterLoad();
                        }
                    };
                    
                    // Beschreibung erstellen
                    const description = document.createElement('p');
                    description.className = 'gallery-caption';
                    description.textContent = `${employeeName} - ${formattedDate}`;
                    
                    // Kommentar hinzuf√ºgen, wenn vorhanden
                    const commentContainer = document.createElement('div');
                    commentContainer.className = 'image-comment';
                    if (file.comment) {
                        commentContainer.innerHTML = `<strong>Kommentar:</strong> ${file.comment}`;
                    } else {
                        commentContainer.innerHTML = '<em>Kein Kommentar vorhanden</em>';
                    }
                    
                    // Elemente zusammenf√ºgen
                    galleryItem.appendChild(img);
                    galleryItem.appendChild(description);
                    galleryItem.appendChild(commentContainer);
                    
                    // In die Galerie einf√ºgen
                    container.appendChild(galleryItem);
                }
                
                console.log(`=== ${files.length} ${type === 'construction_site' ? 'BAUSTELLENFOTOS' : 'DOKUMENTE'} ERFOLGREICH ANGEZEIGT ===`);
                
            } catch (error) {
                console.error(`=== FEHLER BEIM LADEN DER ${type.toUpperCase()}-BILDER ===`);
                console.error('Fehler-Details:', error);
                const containerId = type === 'construction_site' ? 'construction-images' : 'documents-gallery';
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<p class="error">Fehler beim Laden der ${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'}: ${error.message || 'Unbekannter Fehler'}</p>`;
                }
            }
        }
    </script>
    <!-- Lightbox Container -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close">&times;</button>
            <img class="lightbox-img" id="lightbox-img" src="" alt="Vergr√∂√üertes Bild">
            <div class="lightbox-controls">
                <button class="lightbox-prev">&lsaquo;</button>
                <button class="lightbox-next">&rsaquo;</button>
            </div>
        </div>
        <div class="lightbox-caption" id="lightbox-caption"></div>
    </div>

    <script>
        // Lightbox-Funktionalit√§t
        let currentGallery = [];
        let currentImageIndex = 0;
        
        function setupLightbox() {
            // Alle Bilder in den Galerien mit Click-Event versehen
            document.querySelectorAll('.gallery-item').forEach(item => {
                item.addEventListener('click', function() {
                    const img = this.querySelector('img');
                    const imgSrc = img.src;
                    const caption = this.querySelector('p')?.textContent || '';
                    
                    // Pr√ºfen, in welcher Galerie wir sind
                    const galleryContainer = this.closest('.gallery');
                    currentGallery = Array.from(galleryContainer.querySelectorAll('.gallery-item'));
                    currentImageIndex = currentGallery.indexOf(this);
                    
                    openLightbox(imgSrc, caption);
                });
            });
            
            // Lightbox schlie√üen bei Klick auf Schlie√üen-Button
            document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
            
            // Schlie√üen bei Klick au√üerhalb des Bildes
            document.getElementById('lightbox').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLightbox();
                }
            });
            
            // Vor- und Zur√ºck-Buttons
            document.querySelector('.lightbox-prev').addEventListener('click', function(e) {
                e.stopPropagation();
                navigateLightbox(-1);
            });
            
            document.querySelector('.lightbox-next').addEventListener('click', function(e) {
                e.stopPropagation();
                navigateLightbox(1);
            });
            
            // Tastaturnavigation
            document.addEventListener('keydown', function(e) {
                if (!document.getElementById('lightbox').classList.contains('active')) return;
                
                if (e.key === 'Escape') {
                    closeLightbox();
                } else if (e.key === 'ArrowLeft') {
                    navigateLightbox(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateLightbox(1);
                }
            });
        }
        
        function openLightbox(imgSrc, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxCaption = document.getElementById('lightbox-caption');
            
            lightboxImg.src = imgSrc;
            lightboxCaption.textContent = caption;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden'; // Verhindert Scrollen im Hintergrund
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = ''; // Scrollen wieder erlauben
        }
        
        function navigateLightbox(direction) {
            currentImageIndex = (currentImageIndex + direction + currentGallery.length) % currentGallery.length;
            const newItem = currentGallery[currentImageIndex];
            const newImg = newItem.querySelector('img');
            const newCaption = newItem.querySelector('p')?.textContent || '';
            
            document.getElementById('lightbox-img').src = newImg.src;
            document.getElementById('lightbox-caption').textContent = newCaption;
        }
        
        // Lightbox initialisieren, wenn Seite geladen ist
        document.addEventListener('DOMContentLoaded', setupLightbox);
        
        // Lightbox initialisieren, wenn Bilder dynamisch geladen werden
        function initializeLightboxAfterLoad() {
            setupLightbox();
        }
        
        // Die PDF-Export-Funktion wurde in pdf-export.js ausgelagert
        // Export-Button Event-Listener wird im DOMContentLoaded-Event gesetzt
    </script>
    
    <!-- PDF Export Funktion f√ºr Projekte -->
    <script>
        // Komplett neue PDF Export Funktion mit manueller PDF-Erstellung
        async function generateProjectPDF() {
            try {
                console.log('Starte verbesserten PDF-Export...');
                const pdfContent = document.getElementById('pdf-content');
                
                // Status f√ºr Export-Button aktualisieren
                const exportBtn = document.getElementById('export-pdf-btn');
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PDF wird erstellt...';
                }
                
                // Projektdaten f√ºr die erste Seite abrufen
                const projectInfoEl = document.getElementById('project-info');
                const projectTitle = document.querySelector('h1')?.textContent || 'Projektbericht';
                const projectInfo = projectInfoEl?.innerHTML || '';
                
                // Zeiteintr√§ge abrufen
                const timeEntriesTable = document.getElementById('time-entries-table')?.outerHTML || '<p>Keine Zeiteintr√§ge vorhanden</p>';
                
                // Baustellenbilder und Kommentare abrufen
                const images = [];
                document.querySelectorAll('#construction-images .gallery-item, #documents-gallery .gallery-item').forEach(item => {
                    const img = item.querySelector('img');
                    const caption = item.querySelector('.gallery-caption')?.textContent || '';
                    const comment = item.querySelector('.image-comment')?.textContent || '';
                    
                    if (img && img.src) {
                        images.push({
                            src: img.src,
                            caption: caption,
                            comment: comment
                        });
                    }
                });
                
                console.log(`PDF wird mit ${images.length} Bildern erstellt`);
                
                // Manuelle PDF-Erstellung mit jsPDF
                const pdf = new jspdf.jsPDF({ format: 'a4', unit: 'mm' });
                
                // Erste Seite: Titel und Projektinfos
                pdf.setFontSize(24);
                pdf.setTextColor(94, 140, 47); // Lauffer Gr√ºn
                pdf.text(projectTitle, 20, 30);
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                
                // Text f√ºr Projektinfo vorbereiten (nur Text, kein HTML)
                const projectInfoText = projectInfoEl?.textContent.replace(/\s+/g, ' ').trim() || '';
                const splitProjectInfo = pdf.splitTextToSize(projectInfoText, 170);
                pdf.text(splitProjectInfo, 20, 50);
                
                // Zeiteintr√§ge - nur Titel erw√§hnen, da zu komplex f√ºr manuelle Konvertierung
                pdf.text('Zeiteintr√§ge sind im Projekt vorhanden', 20, 100);
                
                // Anzahl der Bilder anzeigen
                pdf.text(`${images.length} Bilder sind im Projekt enthalten und werden auf den folgenden Seiten angezeigt.`, 20, 110);
                
                // Bilder auf separate Seiten, 4 pro Seite
                for (let i = 0; i < images.length; i += 4) {
                    // Neue Seite f√ºr jede Gruppe von 4 Bildern
                    pdf.addPage();
                    
                    // Bilder auf dieser Seite (h√∂chstens 4)
                    const pageImages = images.slice(i, i + 4);
                    
                    // 2x2 Raster f√ºr Bilder
                    for (let j = 0; j < pageImages.length; j++) {
                        const img = pageImages[j];
                        const row = Math.floor(j / 2); // 0 oder 1
                        const col = j % 2;             // 0 oder 1
                        
                        // Position berechnen (Seitenbreite=210mm, H√∂he=297mm)
                        const x = 20 + col * 90;     // 20mm vom Rand, 90mm pro Spalte
                        const y = 20 + row * 130;    // 20mm vom Rand, 130mm pro Zeile
                        
                        try {
                            // Bildgr√∂√üe anpassen (maximal 80x80mm)
                            pdf.addImage(img.src, 'JPEG', x, y, 80, 80, undefined, 'MEDIUM');
                            
                            // Bildunterschrift hinzuf√ºgen
                            pdf.setFontSize(10);
                            pdf.setTextColor(0, 0, 0);
                            const captionLines = pdf.splitTextToSize(img.caption, 80); 
                            pdf.text(captionLines, x, y + 85);
                            
                            // Kommentar hinzuf√ºgen
                            pdf.setFontSize(9);
                            pdf.setTextColor(100, 100, 100);
                            const commentLines = pdf.splitTextToSize(img.comment, 80);
                            pdf.text(commentLines, x, y + 95);
                            
                        } catch (err) {
                            console.error(`Fehler beim Hinzuf√ºgen des Bildes ${j}:`, err);
                            // Fehlernachricht anstelle des Bildes einf√ºgen
                            pdf.setFontSize(10);
                            pdf.setTextColor(255, 0, 0);
                            pdf.text(`[Bild konnte nicht geladen werden]`, x, y + 40);
                        }
                    }
                }
                
                // PDF anzeigen oder speichern
                pdf.save('lauffer-projekt-bericht.pdf');
                
                console.log('PDF Export erfolgreich abgeschlossen');
                
                // Export-Button zur√ºcksetzen
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF exportieren';
                }
                
                return true;
                
            } catch (error) {
                console.error('Schwerwiegender Fehler beim PDF-Export:', error);
                alert(`Fehler beim PDF-Export: ${error.message || 'Unbekannter Fehler'} - Bitte versuchen Sie es erneut.`);
                
                // Export-Button zur√ºcksetzen
                const exportBtn = document.getElementById('export-pdf-btn');
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF exportieren';
                }
                
                return false;
            }
        }
    </script>
    
    <!-- (Entfernt: Doppeltes Zeiteintrag-Bericht Modal) -->
    
    <!-- Modal f√ºr admin Zeiteintrag Erstellung -->
    <div id="admin-time-entry-modal" class="report-modal">
        <div class="report-modal-content">
            <button class="report-modal-close">&times;</button>
            <h3>Neuen Zeiteintrag erstellen</h3>
            <div id="admin-time-entry-form">
                <form id="create-time-entry-form">
                    <div class="form-group">
                        <label for="employee-select">Mitarbeiter:</label>
                        <select id="employee-select" required>
                            <option value="">-- Mitarbeiter ausw√§hlen --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="entry-date">Datum:</label>
                        <input type="date" id="entry-date" required>
                    </div>
                    <div class="form-group">
                        <label for="clock-in-time">Stempelzeit Ein:</label>
                        <input type="time" id="clock-in-time" required>
                    </div>
                    <div class="form-group">
                        <label for="clock-out-time">Stempelzeit Aus:</label>
                        <input type="time" id="clock-out-time" required>
                    </div>
                    <div class="form-group">
                        <label for="pause-time">Pausenzeit (Minuten):</label>
                        <input type="number" id="pause-time" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="entry-notes">Notizen:</label>
                        <textarea id="entry-notes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancel-time-entry-btn" class="btn btn-secondary">Abbrechen</button>
                        <button type="submit" id="save-time-entry-btn" class="btn btn-primary">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Zeiteintrag-Bericht Funktionen -->
    <script src="time-entry-report.js"></script>
    
    <!-- Admin Zeiteintrag Funktionen -->
    <script src="admin-time-entry.js"></script>
    
    <!-- Admin-Funktionen -->
    <script src="admin-vehicle-usage.js"></script>
    
    <!-- Report-functions und PDF-Export am Ende laden -->
    <script src="report-functions.js"></script>
    <script src="pdf-export.js"></script>
    
    <!-- Admin Time Entry Modal -->
    <div id="admin-time-entry-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Zeiteintrag hinzuf√ºgen</h2>
            <form id="admin-time-entry-form">
                <div class="form-group">
                    <label for="employee-select">Mitarbeiter:</label>
                    <select id="employee-select" required>
                        <option value="">-- Mitarbeiter ausw√§hlen --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="entry-date">Datum:</label>
                    <input type="date" id="entry-date" required>
                </div>
                <div class="form-group time-inputs">
                    <div>
                        <label for="clock-in-time">Beginn:</label>
                        <input type="time" id="clock-in-time" required>
                    </div>
                    <div>
                        <label for="clock-out-time">Ende:</label>
                        <input type="time" id="clock-out-time" required>
                    </div>
                    <div>
                        <label for="pause-time">Pause (Min):</label>
                        <input type="number" id="pause-time" min="0" value="30">
                    </div>
                </div>
                <div class="form-group">
                    <label for="entry-notes">Notizen:</label>
                    <textarea id="entry-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-time-entry-btn" class="btn btn-secondary">Abbrechen</button>
                    <button type="submit" id="save-time-entry-btn" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Vehicle Usage Modal -->
    <div id="admin-vehicle-usage-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Fahrzeugbuchung hinzuf√ºgen</h2>
            <form id="admin-vehicle-usage-form">
                <div class="form-group">
                    <label for="vehicle-usage-employee-select">Mitarbeiter:</label>
                    <select id="vehicle-usage-employee-select" required>
                        <option value="">-- Mitarbeiter ausw√§hlen --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicle-select">Fahrzeug:</label>
                    <select id="vehicle-select" required>
                        <option value="">-- Fahrzeug ausw√§hlen --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicle-usage-date">Datum:</label>
                    <input type="date" id="vehicle-usage-date" required>
                </div>
                <div class="form-group">
                    <label for="start-km">Startkilometer:</label>
                    <input type="number" id="start-km" required min="0">
                </div>
                <div class="form-group">
                    <label for="end-km">Endkilometer:</label>
                    <input type="number" id="end-km" required min="0">
                </div>
                <div class="form-group">
                    <label for="vehicle-usage-notes">Notizen:</label>
                    <textarea id="vehicle-usage-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-vehicle-usage-btn" class="btn btn-secondary">Abbrechen</button>
                    <button type="submit" id="save-vehicle-usage-btn" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal f√ºr Zeiteintrags-Bearbeitung -->
    <div id="edit-time-entry-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Zeiteintrag bearbeiten</h3>
                <span class="close-modal" onclick="closeEditTimeEntryModal()">&times;</span>
            </div>
            <form id="edit-time-entry-form">
                <input type="hidden" id="edit-entry-id">
                
                <div class="form-group">
                    <label for="edit-employee-name">Mitarbeiter:</label>
                    <input type="text" id="edit-employee-name" readonly>
                </div>
                
                <div class="form-group">
                    <label for="edit-entry-date">Datum:</label>
                    <input type="date" id="edit-entry-date" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-clock-in-time">Einstempelzeit:</label>
                    <input type="time" id="edit-clock-in-time" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-clock-out-time">Ausstempelzeit:</label>
                    <input type="time" id="edit-clock-out-time">
                </div>
                
                <div class="form-group">
                    <label for="edit-pause-time">Pausenzeit (Minuten):</label>
                    <input type="number" id="edit-pause-time" min="0" value="0">
                </div>
                
                <div class="form-group">
                    <label for="edit-notes">Notizen:</label>
                    <textarea id="edit-notes" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="edit-reason">Grund f√ºr die √Ñnderung:</label>
                    <textarea id="edit-reason" rows="2" placeholder="Bitte geben Sie den Grund f√ºr die Korrektur an..." required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTimeEntryModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // JavaScript-Funktionen f√ºr die Zeiteintrags-Bearbeitung
        
        // Globale Variable f√ºr den aktuell zu bearbeitenden Zeiteintrag
        let currentEditingEntry = null;
        
        // Modal √∂ffnen und Daten laden
        async function openEditTimeEntryModal(entryId) {
            try {
                console.log('√ñffne Edit-Modal f√ºr Zeiteintrag:', entryId);
                
                // Zeiteintrag aus der Datenbank laden
                const timeEntry = await DataService.getTimeEntryById(entryId);
                if (!timeEntry) {
                    alert('Zeiteintrag nicht gefunden!');
                    return;
                }
                
                // Mitarbeiterdaten laden
                const employee = await DataService.getEmployeeById(timeEntry.employeeId);
                if (!employee) {
                    alert('Mitarbeiterdaten nicht gefunden!');
                    return;
                }
                
                // Aktuellen Eintrag speichern
                currentEditingEntry = timeEntry;
                
                // Modal-Felder f√ºllen
                document.getElementById('edit-entry-id').value = timeEntry.id;
                document.getElementById('edit-employee-name').value = employee.name;
                
                // Datum aus clockInTime extrahieren
                const clockInDate = timeEntry.clockInTime instanceof firebase.firestore.Timestamp ? 
                    timeEntry.clockInTime.toDate() : new Date(timeEntry.clockInTime);
                
                document.getElementById('edit-entry-date').value = clockInDate.toISOString().split('T')[0];
                document.getElementById('edit-clock-in-time').value = clockInDate.toTimeString().substr(0, 5);
                
                // Ausstempelzeit, falls vorhanden
                if (timeEntry.clockOutTime) {
                    const clockOutDate = timeEntry.clockOutTime instanceof firebase.firestore.Timestamp ? 
                        timeEntry.clockOutTime.toDate() : new Date(timeEntry.clockOutTime);
                    document.getElementById('edit-clock-out-time').value = clockOutDate.toTimeString().substr(0, 5);
                }
                
                // Pausenzeit in Minuten konvertieren - unterst√ºtzt beide Formate
                let pauseMinutes = 0;
                if (timeEntry.pauseTotalTime && timeEntry.pauseTotalTime > 0) {
                    // Neues Format: pauseTotalTime in Millisekunden
                    pauseMinutes = Math.floor(timeEntry.pauseTotalTime / 60000);
                } else if (timeEntry.pauseTime && timeEntry.pauseTime > 0) {
                    // Altes Format: pauseTime in Minuten
                    pauseMinutes = timeEntry.pauseTime;
                }
                console.log('üìù Edit-Modal: Pausenzeit geladen:', {
                    pauseTotalTime: timeEntry.pauseTotalTime,
                    pauseTime: timeEntry.pauseTime,
                    pauseMinutes: pauseMinutes
                });
                document.getElementById('edit-pause-time').value = pauseMinutes;
                
                // Notizen
                document.getElementById('edit-notes').value = timeEntry.notes || '';
                
                // Grund-Feld leeren
                document.getElementById('edit-reason').value = '';
                
                // Modal anzeigen
                document.getElementById('edit-time-entry-modal').classList.add('visible');
                
            } catch (error) {
                console.error('Fehler beim √ñffnen des Edit-Modals:', error);
                alert('Fehler beim Laden der Daten: ' + error.message);
            }
        }
        
        // Modal schlie√üen
        function closeEditTimeEntryModal() {
            document.getElementById('edit-time-entry-modal').classList.remove('visible');
            currentEditingEntry = null;
        }
        
        // Zeiteintrag l√∂schen mit Best√§tigung
        async function deleteTimeEntry(entryId) {
            try {
                console.log('L√∂sche Zeiteintrag:', entryId);
                
                // Zeiteintrag laden, um Details f√ºr die Best√§tigung anzuzeigen
                const timeEntry = await DataService.getTimeEntryById(entryId);
                if (!timeEntry) {
                    alert('Zeiteintrag nicht gefunden!');
                    return;
                }
                
                // Mitarbeiterdaten laden
                const employee = await DataService.getEmployeeById(timeEntry.employeeId);
                const employeeName = employee ? employee.name : 'Unbekannter Mitarbeiter';
                
                // Datum formatieren
                const clockInDate = timeEntry.clockInTime instanceof firebase.firestore.Timestamp ? 
                    timeEntry.clockInTime.toDate() : new Date(timeEntry.clockInTime);
                const dateStr = clockInDate.toLocaleDateString('de-DE');
                
                // Best√§tigung vom Benutzer einholen
                const confirmMessage = `M√∂chten Sie diesen Zeiteintrag wirklich l√∂schen?\n\n` +
                    `Mitarbeiter: ${employeeName}\n` +
                    `Datum: ${dateStr}\n\n` +
                    `Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!`;
                
                if (!confirm(confirmMessage)) {
                    console.log('L√∂schen abgebrochen');
                    return;
                }
                
                // Zeiteintrag l√∂schen
                await DataService.deleteTimeEntry(entryId);
                
                // Erfolgsbenachrichtigung
                alert('Zeiteintrag erfolgreich gel√∂scht!');
                
                // Tabelle neu laden
                await loadTimeEntries();
                
                console.log('‚úÖ Zeiteintrag erfolgreich gel√∂scht und Tabelle aktualisiert');
                
            } catch (error) {
                console.error('Fehler beim L√∂schen des Zeiteintrags:', error);
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }
        
        // Validierung der Eingaben
        function validateTimeEntry() {
            const entryDate = document.getElementById('edit-entry-date').value;
            const clockInTime = document.getElementById('edit-clock-in-time').value;
            const clockOutTime = document.getElementById('edit-clock-out-time').value;
            const pauseTime = parseInt(document.getElementById('edit-pause-time').value) || 0;
            const reason = document.getElementById('edit-reason').value.trim();
            
            // Validierung: Alle Pflichtfelder m√ºssen ausgef√ºllt sein
            if (!entryDate || !clockInTime || !reason) {
                alert('Bitte alle Pflichtfelder ausf√ºllen!');
                return false;
            }
            
            // Validierung: Ausstempelzeit muss nach Einstempelzeit liegen
            if (clockOutTime) {
                const clockInDateTime = new Date(`${entryDate}T${clockInTime}`);
                const clockOutDateTime = new Date(`${entryDate}T${clockOutTime}`);
                
                if (clockOutDateTime <= clockInDateTime) {
                    alert('Die Ausstempelzeit muss nach der Einstempelzeit liegen!');
                    return false;
                }
                
                // Validierung: Pausenzeit darf nicht l√§nger als Arbeitszeit sein
                const workTimeMs = clockOutDateTime - clockInDateTime;
                const pauseTimeMs = pauseTime * 60 * 1000;
                
                if (pauseTimeMs >= workTimeMs) {
                    alert('Die Pausenzeit darf nicht l√§nger oder gleich der Arbeitszeit sein!');
                    return false;
                }
            }
            
            // Validierung: Datum darf nicht in der Zukunft liegen
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Bis Ende des heutigen Tages erlauben
            const entryDateTime = new Date(entryDate);
            
            if (entryDateTime > today) {
                alert('Das Datum darf nicht in der Zukunft liegen!');
                return false;
            }
            
            return true;
        }
        
        // Formular-Submit-Handler
        document.getElementById('edit-time-entry-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Eingaben validieren
            if (!validateTimeEntry()) {
                return;
            }
            
            try {
                // Formulardaten auslesen
                const entryId = document.getElementById('edit-entry-id').value;
                const entryDate = document.getElementById('edit-entry-date').value;
                const clockInTime = document.getElementById('edit-clock-in-time').value;
                const clockOutTime = document.getElementById('edit-clock-out-time').value;
                const pauseTime = parseInt(document.getElementById('edit-pause-time').value) || 0;
                const notes = document.getElementById('edit-notes').value;
                const reason = document.getElementById('edit-reason').value.trim();
                
                // Neue Datetime-Objekte erstellen
                const newClockInTime = new Date(`${entryDate}T${clockInTime}`);
                const newClockOutTime = clockOutTime ? new Date(`${entryDate}T${clockOutTime}`) : null;
                const pauseTotalTime = pauseTime * 60 * 1000; // Minuten zu Millisekunden
                
                // Aktuellen Benutzer f√ºr Audit-Trail ermitteln
                const currentAdmin = DataService.getCurrentAdmin();
                const currentUser = DataService.getCurrentUser();
                const editorInfo = currentAdmin ? 
                    { id: currentAdmin.uid || 'admin', name: currentAdmin.name || currentAdmin.username } :
                    { id: currentUser?.id || 'unknown', name: currentUser?.name || 'Unknown' };
                
                // Update-Daten zusammenstellen
                const updateData = {
                    clockInTime: newClockInTime,
                    notes: notes,
                    pauseTotalTime: pauseTotalTime,
                    // Audit-Trail hinzuf√ºgen
                    lastEditedAt: new Date(),
                    lastEditedBy: editorInfo.id,
                    lastEditedByName: editorInfo.name,
                    editReason: reason
                };
                
                // Ausstempelzeit hinzuf√ºgen, falls vorhanden
                if (newClockOutTime) {
                    updateData.clockOutTime = newClockOutTime;
                } else {
                    // Ausstempelzeit explizit auf null setzen, falls sie entfernt wurde
                    updateData.clockOutTime = null;
                }
                
                console.log('Aktualisiere Zeiteintrag:', entryId, updateData);
                
                // In Firestore aktualisieren
                await DataService.updateTimeEntry(entryId, updateData);
                
                // Erfolg!
                alert('Zeiteintrag wurde erfolgreich aktualisiert!');
                
                // Modal schlie√üen
                closeEditTimeEntryModal();
                
                // Zeiteintr√§ge-Tabelle neu laden
                if (typeof loadTimeEntries === 'function') {
                    await loadTimeEntries();
                } else if (typeof loadProjectTimeEntries === 'function' && projectId) {
                    // project-detail.js Funktion aufrufen
                    await loadProjectTimeEntries(projectId);
                } else {
                    // Seite neu laden als Fallback
                    location.reload();
                }

                // Report-Buttons nachladen (Re-Inject), damit der Berichts-Button nach √Ñnderungen wieder korrekt angezeigt wird
                setTimeout(() => {
                    try {
                        if (window.currentProjectId) {
                            console.log('üîÑ Re-Inject der Report-Buttons f√ºr Projekt', window.currentProjectId);
                            if (window.processedRows && typeof window.processedRows.clear === 'function') {
                                console.log('üßπ processedRows Set zur√ºcksetzen');
                                window.processedRows.clear();
                            }
                            if (typeof window.waitForTimeEntriesTableAndInjectButtons === 'function') {
                                window.waitForTimeEntriesTableAndInjectButtons(window.currentProjectId, 15, 0, 300);
                            } else if (typeof window.injectReportButtons === 'function') {
                                window.injectReportButtons(window.currentProjectId);
                            } else {
                                console.warn('‚ö†Ô∏è Keine Report-Button Funktion gefunden (injectReportButtons / waitForTimeEntriesTableAndInjectButtons)');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è currentProjectId nicht gesetzt ‚Äì kann Report-Buttons nicht re-injecten');
                        }
                    } catch (reinjectionError) {
                        console.error('Fehler beim Re-Inject der Report-Buttons:', reinjectionError);
                    }
                }, 400); // leichte Verz√∂gerung bis DOM aktualisiert ist
                
            } catch (error) {
                console.error('Fehler beim Aktualisieren des Zeiteintrags:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        });
        
        // Hilfsfunktion: Aktueller Benutzer f√ºr Kompatibilit√§t
        function getCurrentUser() {
            return DataService.getCurrentUser();
        }

        // Funktion zum √ñffnen des Edit-Modals aus dem Report heraus (global verf√ºgbar)
        window.editTimeEntryFromReport = function(entryId) {
            console.log('editTimeEntryFromReport aufgerufen mit ID:', entryId);
            // Report-Modal schlie√üen (falls vorhanden)
            const reportModal = document.getElementById('time-entry-report-modal');
            if (reportModal) {
                reportModal.style.display = 'none';
                reportModal.classList.remove('visible');
            }
            
            // Edit-Modal √∂ffnen
            setTimeout(() => {
                openEditTimeEntryModal(entryId);
            }, 100);
        };
        
        // Modal bei Klick au√üerhalb schlie√üen
        document.getElementById('edit-time-entry-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditTimeEntryModal();
            }
        });
        
        // ESC-Taste zum Schlie√üen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('edit-time-entry-modal').classList.contains('visible')) {
                closeEditTimeEntryModal();
            }
        });
        
        console.log('Edit-Modal Funktionen geladen');
        
        // Funktion zum Initialisieren der zuklappbaren Sections
        function initCollapsibleSections() {
            console.log('üîÑ Initialisiere zuklappbare Sections...');
            const headers = document.querySelectorAll('.collapsible-header');
            console.log('üìã Gefundene Headers:', headers.length);
            
            headers.forEach((header, index) => {
                // Pr√ºfe ob bereits initialisiert (verhindert mehrfache Event-Listener)
                if (header.dataset.initialized === 'true') {
                    console.log(`‚è≠Ô∏è Header ${index} bereits initialisiert, √ºberspringe`);
                    return;
                }
                
                const toggleBtn = header.querySelector('.collapse-toggle-btn');
                const targetId = header.getAttribute('data-target');
                const content = document.getElementById(targetId);
                
                console.log(`Header ${index}:`, {
                    hasToggleBtn: !!toggleBtn,
                    targetId: targetId,
                    hasContent: !!content
                });
                
                if (!content) {
                    console.warn(`‚ö†Ô∏è Content nicht gefunden f√ºr ID: ${targetId}`);
                    return;
                }
                
                // Standardm√§√üig eingeklappt (nur beim ersten Mal)
                if (!content.classList.contains('expanded')) {
                    content.classList.add('collapsed');
                    content.classList.remove('expanded');
                    header.classList.remove('expanded');
                }
                
                // Event-Listener f√ºr Header-Klick (nur einmal hinzuf√ºgen)
                header.addEventListener('click', function(e) {
                    // Verhindere Toggle wenn auf Button geklickt wird (Button hat eigenen Listener)
                    if (e.target.closest('.collapse-toggle-btn')) {
                        return;
                    }
                    console.log('üìå Header geklickt:', targetId);
                    toggleSection(header, content);
                });
                
                // Event-Listener f√ºr Toggle-Button (nur einmal hinzuf√ºgen)
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('üìå Toggle-Button geklickt:', targetId);
                        toggleSection(header, content);
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Toggle-Button nicht gefunden f√ºr Header ${index}`);
                }
                
                // Markiere als initialisiert
                header.dataset.initialized = 'true';
            });
            
            console.log('‚úÖ Zuklappbare Sections initialisiert');
        }
        
        // Funktion zum Ein-/Ausklappen einer Section
        function toggleSection(header, content) {
            console.log('üîÑ Toggle Section:', {
                hasCollapsed: content.classList.contains('collapsed'),
                hasExpanded: content.classList.contains('expanded'),
                contentId: content.id
            });
            
            const isCollapsed = content.classList.contains('collapsed');
            
            // Entferne beide Klassen zuerst, dann f√ºge die richtige hinzu
            content.classList.remove('collapsed', 'expanded');
            header.classList.remove('expanded');
            
            if (isCollapsed) {
                // Ausklappen
                console.log('‚¨áÔ∏è Klappe aus...');
                content.classList.add('expanded');
                header.classList.add('expanded');
            } else {
                // Einklappen
                console.log('‚¨ÜÔ∏è Klappe ein...');
                content.classList.add('collapsed');
            }
            
            // Force reflow f√ºr Animation
            void content.offsetHeight;
            
            console.log('‚úÖ Nach Toggle:', {
                hasCollapsed: content.classList.contains('collapsed'),
                hasExpanded: content.classList.contains('expanded'),
                computedMaxHeight: window.getComputedStyle(content).maxHeight
            });
        }
        
        // Funktion global verf√ºgbar machen
        window.initCollapsibleSections = initCollapsibleSections;
        window.toggleSection = toggleSection;
        
        // Initialisierung beim DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÖ DOMContentLoaded - Initialisiere Sections');
                initCollapsibleSections();
            });
        } else {
            // DOM ist bereits geladen
            console.log('üìÖ DOM bereits geladen - Initialisiere Sections sofort');
            setTimeout(() => initCollapsibleSections(), 100);
        }
    </script>
</body>
</html>
