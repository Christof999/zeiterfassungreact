<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vereinfachte Projektdetails - Lauffer Zeiterfassung</title>
    <!-- Firebase-SDKs einbinden -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- PDF Export Bibliothek -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Datenservice und Hilfsfunktionen -->
    <script src="firebase-config.js"></script>
    <script src="data.js"></script>
    <!-- Wir laden report-functions.js und pdf-export.js am Ende des Body-Tags -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Verbessertes CSS f√ºr die Darstellung - an Lauffer-Design angepasst */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        
        .actions-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: #446d23; /* Lauffer-Gr√ºn f√ºr √úberschriften */
            font-weight: 600;
        }
        
        h1 {
            margin-bottom: 1rem;
            color: #5e8c2f; /* Helleres Gr√ºn f√ºr H1 */
            border-bottom: 2px solid #5e8c2f;
            padding-bottom: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 0px;
            border-top: 5px solid #5e8c2f; /* Gr√ºner Rand oben */
        }
        
        .info-box {
            background-color: #f5f9ee; /* Helles Gr√ºn f√ºr Info-Box */
            border-left: 5px solid #5e8c2f;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
        }
        
        .btn {
            display: inline-block;
            background-color: #5e8c2f; /* Gr√ºn f√ºr Buttons */
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 2px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
            margin: 5px 0;
        }
        
        .btn:hover {
            background-color: #446d23; /* Dunkleres Gr√ºn f√ºr Hover */
        }
        
        .btn.btn-export {
            background-color: #8b5a2b; /* Braun f√ºr Export-Button */
        }
        
        .btn.btn-export:hover {
            background-color: #704820; /* Dunkleres Braun f√ºr Hover */
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        th, td {
            border: 1px solid #e0e0e0;
            padding: 10px 12px;
            text-align: left;
        }
        
        th {
            background-color: #5e8c2f; /* Gr√ºn f√ºr Tabellenkopf */
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f5f9ee; /* Leicht gr√ºnlicher Hover */
        }
        
        section {
            margin-bottom: 25px;
            padding-bottom: 5px;
        }
        
        /* PDF-optimierte Galeriedarstellung */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        /* Stile f√ºr den PDF-Export */
        @media print {
            .gallery {
                grid-template-columns: 1fr 1fr;
                page-break-inside: avoid;
            }
            .gallery-item {
                page-break-inside: avoid;
                margin-bottom: 15px;
            }
        }
        .gallery-item {
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .gallery-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .gallery-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        .btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            text-decoration: none;
        }
        .btn:hover {
            background-color: #005a9e;
        }
        
        /* Lightbox Stile */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .lightbox.active {
            display: flex;
        }
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 80%;
            margin: 20px;
        }
        .lightbox-img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        .lightbox-caption {
            color: white;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 4px;
            max-width: 80%;
            text-align: center;
        }
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .lightbox-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 0 20px;
            box-sizing: border-box;
        }
        .lightbox-prev, .lightbox-next {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lightbox-prev:hover, .lightbox-next:hover {
            background: rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 id="project-title">Projektbericht</h1>
            <div class="actions-container">
                <button id="export-btn" class="btn btn-export"><i class="fas fa-file-pdf"></i> PDF exportieren</button>
                <a href="index.html" id="back-link" class="btn"><i class="fas fa-arrow-left"></i> Zur√ºck zur Hauptseite</a>
            </div>
        </div>
        <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Hier finden Sie alle Details zum ausgew√§hlten Projekt sowie zugeh√∂rige Zeiterfassungseintr√§ge, Baustellenfotos und Dokumente. Mit dem Export-Button k√∂nnen Sie einen vollst√§ndigen PDF-Bericht erstellen.</p>
        </div>
        
        <div id="pdf-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: #5e8c2f;">LAUFFER Gartenbau - Projektbericht</h2>
            </div>
            
            <section>
                <h2><i class="fas fa-briefcase"></i> Projektdetails</h2>
                <div class="info-box" id="project-info">
                    Projektinformationen werden geladen...
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-clock"></i> Zeiteintr√§ge</h2>
                <div id="time-entries-container">
                    <p>Zeiteintr√§ge werden geladen...</p>
                    <table id="time-entries-table">
                        <thead>
                            <tr>
                                <th>Mitarbeiter</th>
                                <th>Datum</th>
                                <th>Stempelzeit Ein</th>
                                <th>Stempelzeit Aus</th>
                                <th>Arbeitszeit</th>
                                <th>Notizen</th>
                            </tr>
                        </thead>
                        <tbody id="time-entries-body">
                            <!-- Zeiteintr√§ge werden hier eingef√ºgt -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-camera"></i> Baustellenbilder</h2>
                <div id="construction-images" class="gallery">
                    <p>Bilder werden geladen...</p>
                </div>
            </section>
            
            <section>
                <h2><i class="fas fa-file-alt"></i> Lieferscheine und Dokumente</h2>
                <div id="documents-gallery" class="gallery">
                    <p>Dokumente werden geladen...</p>
                </div>
            </section>
        </div>
    </div>
    
    <script>
        // DEBUG: Sofortige Ausgabe zur Verfolgung
        console.log('=== PROJECT-SIMPLE.HTML SCRIPT WIRD AUSGEF√úHRT ===');
        console.log('Zeitpunkt:', new Date().toISOString());
        
        // Firebase sollte bereits durch firebase-config.js initialisiert sein
        console.log('üîß Firebase bereits initialisiert:', !!firebase);
        console.log('üîß Firebase Apps:', firebase.apps ? firebase.apps.map(app => app.name) : 'nicht verf√ºgbar');
        console.log('üîß Firestore verf√ºgbar:', typeof firebase.firestore !== 'undefined');
        console.log('üîß Storage verf√ºgbar:', typeof firebase.storage !== 'undefined');
        
        // Globale Variablen  
        let projectId = null;
        let allProjectFiles = null; // Cache f√ºr alle Projektdateien
        
        // DOM-Elemente - werden nach DOM-Load initialisiert
        let pdfContent, exportBtn, projectTitleEl, projectInfoEl, timeEntriesBodyEl, constructionImagesEl, documentsGalleryEl, backLinkEl;
        
        // Seite initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== PROJECT-SIMPLE.HTML DOMCONTENTLOADED AUSGEF√úHRT ===');
            console.log('=== PROJECT-SIMPLE.HTML INITIALISIERUNG GESTARTET ===');
            console.log('DOM Content Loaded - Starte Initialisierung');
            console.log('Aktuelle URL:', window.location.href);
            console.log('Document ready state:', document.readyState);
            
            // Kleiner Timeout, um sicherzustellen, dass alle anderen Scripts geladen sind
            setTimeout(function() {
                initializeProjectSimple();
            }, 100);
        });
        
        function initializeProjectSimple() {
            console.log('=== INITIALISIERE PROJECT-SIMPLE ===');
            
            // DOM-Elemente nach DOM-Load finden
            pdfContent = document.getElementById('pdf-content');
            exportBtn = document.getElementById('export-btn');
            projectTitleEl = document.getElementById('project-title');
            projectInfoEl = document.getElementById('project-info');
            timeEntriesBodyEl = document.getElementById('time-entries-body');
            constructionImagesEl = document.getElementById('construction-images');
            documentsGalleryEl = document.getElementById('documents-gallery');
            backLinkEl = document.getElementById('back-link');
            
            // Debug: DOM-Elemente pr√ºfen
            console.log('=== DOM-ELEMENTE PR√úFUNG ===');
            console.log('pdfContent:', pdfContent ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('exportBtn:', exportBtn ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('projectTitleEl:', projectTitleEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('projectInfoEl:', projectInfoEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('timeEntriesBodyEl:', timeEntriesBodyEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('constructionImagesEl:', constructionImagesEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('documentsGalleryEl:', documentsGalleryEl ? 'gefunden' : 'NICHT GEFUNDEN');
            console.log('backLinkEl:', backLinkEl ? 'gefunden' : 'NICHT GEFUNDEN');
            
            // Event-Listener f√ºr Export-Button
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    console.log('PDF-Export-Button geklickt');
                    if (typeof generatePDF === 'function') {
                        generatePDF();
                    } else {
                        console.error('generatePDF-Funktion nicht verf√ºgbar');
                        alert('PDF-Export-Funktion ist nicht verf√ºgbar.');
                    }
                });
            }
            
            // Projekt-ID aus der URL auslesen
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');
            
            console.log('üîç URL-Parsing:');
            console.log('   - Komplette URL:', window.location.href);
            console.log('   - Search-String:', window.location.search);
            console.log('   - Alle URL-Parameter:', Object.fromEntries(urlParams));
            console.log('   - Extrahierte Projekt-ID:', projectId);
            console.log('   - Projekt-ID Typ:', typeof projectId);
            console.log('   - Projekt-ID L√§nge:', projectId ? projectId.length : 'null');
            
            if (!projectId) {
                console.error('‚ùå FEHLER: Keine Projekt-ID in der URL gefunden.');
                console.log('üí° Erwartete URL-Format: project-simple.html?id=PROJEKT_ID');
                showError('Keine Projekt-ID in der URL gefunden. Bitte w√§hlen Sie ein Projekt von der Hauptseite aus.');
                return;
            }
            
            // TEMP: Firestore-Verbindung testen bevor wir das Projekt laden
            console.log('üß™ Teste Firestore-Verbindung...');
            testFirestoreConnection().then(() => {
                console.log('‚úÖ Firestore-Test abgeschlossen, starte Projekt-Laden...');
            }).catch(error => {
                console.error('‚ùå Firestore-Test fehlgeschlagen:', error);
                showError('Firestore-Verbindung fehlgeschlagen: ' + error.message);
            });
        }
        
        async function testFirestoreConnection() {
            try {
                console.log('üß™ Teste einfache Firestore-Abfrage...');
                
                // Timeout f√ºr den Test hinzuf√ºgen
                const testPromise = DataService.projectsCollection.limit(1).get();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firestore-Test Timeout nach 5s')), 5000)
                );
                
                const testQuery = await Promise.race([testPromise, timeoutPromise]);
                console.log('‚úÖ Firestore-Test erfolgreich, Anzahl Docs:', testQuery.size);
                
                // Nach erfolgreichem Test das Projekt laden
                console.log('üöÄ Starte Projekt-Laden nach erfolgreichem Firestore-Test...');
                loadProject();
                
            } catch (testError) {
                console.error('‚ùå Firestore-Test fehlgeschlagen:', testError);
                console.error('‚ùå Fehler-Details:', testError.message);
                
                if (testError.message.includes('Timeout')) {
                    console.error('‚è∞ Firestore h√§ngt - verwende alternative Methode');
                    // Versuche trotzdem das Projekt zu laden
                    console.log('üîÑ Versuche Projekt-Laden trotz Firestore-Test-Timeout...');
                    loadProject();
                } else {
                    throw testError;
                }
            }
            
            // Back-Link aktualisieren
            if (backLinkEl) {
                backLinkEl.href = `index.html`;
                console.log('Back-Link aktualisiert');
            }
            
            // Debug-Ausgabe zur Verfolgung
            console.log('=== STARTE LADEN DER PROJEKTDATEN ===');
            console.log('Projekt-ID f√ºr Laden:', projectId);
            
            // Daten laden
            console.log('Rufe loadProject() auf...');
            loadProject().then(() => {
                console.log('loadProject() abgeschlossen');
            }).catch(error => {
                console.error('loadProject() fehlgeschlagen:', error);
                showError('Fehler beim Laden des Projekts: ' + error.message);
            });
        }
        
        // Hilfsfunktion: Fehler anzeigen
        function showError(message) {
            console.error('FEHLER:', message);
            
            // Fehler in allen relevanten Containern anzeigen
            const containers = [
                document.getElementById('project-info'),
                document.getElementById('time-entries-container'),
                document.getElementById('construction-images'),
                document.getElementById('documents-gallery')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.innerHTML = `<div style="color: red; padding: 20px; border: 1px solid red; background-color: #ffe6e6; border-radius: 4px;">
                        <strong>Fehler:</strong> ${message}
                    </div>`;
                }
            });
            
            // Auch als Alert anzeigen
            alert('Fehler: ' + message);
        }
        
        // Projekt laden
        async function loadProject() {
            try {
                console.log('üöÄ === PROJEKT LADEN GESTARTET ===');
                console.log('üéØ Versuche Projekt zu laden mit ID:', projectId);
                
                // DataService-Verf√ºgbarkeit pr√ºfen
                if (typeof DataService === 'undefined') {
                    throw new Error('DataService ist nicht verf√ºgbar. Pr√ºfen Sie, ob data.js geladen wurde.');
                }
                console.log('‚úÖ DataService ist verf√ºgbar');
                
                // DataService-Initialisierung pr√ºfen
                console.log('üîß DataService.db verf√ºgbar:', !!DataService.db);
                console.log('üîß DataService.projectsCollection verf√ºgbar:', !!DataService.projectsCollection);
                
                // DataService initialisieren, falls noch nicht geschehen
                if (!DataService.db) {
                    console.log('üîÑ Initialisiere DataService...');
                    await DataService.init();
                    console.log('‚úÖ DataService initialisiert');
                } else {
                    console.log('‚úÖ DataService bereits initialisiert');
                }
                
                // Verf√ºgbare Methoden loggen
                console.log('üõ†Ô∏è Verf√ºgbare DataService-Methoden:', 
                    Object.getOwnPropertyNames(DataService)
                        .filter(name => typeof DataService[name] === 'function')
                        .sort()
                );
                
                // Projekt aus der Datenbank laden √ºber DataService
                console.log('üì• Lade Projektdokument √ºber DataService...');
                console.log('üìã Rufe DataService.getProjectById auf mit ID:', projectId);
                
                // Timeout f√ºr den getProjectById Aufruf
                const projectPromise = DataService.getProjectById(projectId);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: getProjectById dauert zu lange (10s)')), 10000)
                );
                
                console.log('‚è±Ô∏è Starte getProjectById mit 10s Timeout...');
                const project = await Promise.race([projectPromise, timeoutPromise]);
                console.log('üì§ DataService.getProjectById Ergebnis:', project);
                console.log('üì§ Projekt-Typ:', typeof project);
                console.log('üì§ Projekt-Keys:', project ? Object.keys(project) : 'null');
                
                if (!project) {
                    console.error('‚ùå Projekt nicht gefunden f√ºr ID:', projectId);
                    console.log('üí° M√∂gliche Ursachen:');
                    console.log('   - Projekt-ID existiert nicht in der Datenbank');
                    console.log('   - Firestore-Verbindungsprobleme');
                    console.log('   - Unzureichende Berechtigung');
                    showError('Projekt nicht gefunden.');
                    return;
                }
                
                console.log('=== PROJEKT ERFOLGREICH GELADEN ===');
                console.log('Projekt-Daten:', project);
                
                // Projektdaten anzeigen
                if (projectTitleEl) {
                    projectTitleEl.textContent = project.name || 'Unbenanntes Projekt';
                    console.log('Projekt-Titel gesetzt:', project.name);
                } else {
                    console.error('projectTitleEl nicht gefunden!');
                }
                
                let infoText = '';
                if (project.client) infoText += `<strong>Kunde:</strong> ${project.client}<br>`;
                if (project.location) infoText += `<strong>Standort:</strong> ${project.location}<br>`;
                if (project.startDate) {
                    const startDate = project.startDate instanceof firebase.firestore.Timestamp ?
                        project.startDate.toDate() : new Date(project.startDate);
                    infoText += `<strong>Startdatum:</strong> ${startDate.toLocaleDateString('de-DE')}<br>`;
                }
                if (project.endDate) {
                    const endDate = project.endDate instanceof firebase.firestore.Timestamp ?
                        project.endDate.toDate() : new Date(project.endDate);
                    infoText += `<strong>Enddatum:</strong> ${endDate.toLocaleDateString('de-DE')}<br>`;
                }
                if (project.description) infoText += `<strong>Beschreibung:</strong> ${project.description}`;
                
                if (projectInfoEl) {
                    projectInfoEl.innerHTML = infoText;
                    console.log('Projekt-Info gesetzt:', infoText);
                } else {
                    console.error('projectInfoEl nicht gefunden!');
                }
                
                // Zeiteintr√§ge, Bilder und Dokumente laden
                console.log('=== STARTE LADEN DER UNTERGEORDNETEN DATEN ===');
                
                console.log('1. Lade Zeiteintr√§ge...');
                await loadTimeEntries();
                
                console.log('2. Lade Baustellenbilder...');
                await loadProjectImages('construction_site');
                
                console.log('3. Lade Dokumente...');
                await loadProjectImages('delivery_note');
                
                console.log('=== ALLE DATEN ERFOLGREICH GELADEN ===');
                
            } catch (error) {
                console.error('=== FEHLER BEIM LADEN DES PROJEKTS ===');
                console.error('Fehler-Typ:', error.constructor.name);
                console.error('Fehler-Message:', error.message);
                console.error('Fehler-Stack:', error.stack);
                console.error('Fehler-Objekt:', error);
                
                // Spezielle Behandlung f√ºr verschiedene Fehlertypen
                if (error.message && error.message.includes('Timeout')) {
                    console.error('üïê TIMEOUT-FEHLER: DataService.getProjectById dauert zu lange');
                    showError('Timeout: Das Laden des Projekts dauert zu lange. Bitte pr√ºfen Sie Ihre Internetverbindung.');
                } else if (error.message && error.message.includes('permission')) {
                    console.error('üîí BERECHTIGUNGS-FEHLER: Keine Berechtigung f√ºr Firestore');
                    showError('Berechtigungsfehler: Keine Berechtigung zum Laden des Projekts.');
                } else {
                    console.error('‚ùì UNBEKANNTER FEHLER beim Laden des Projekts');
                    showError('Fehler beim Laden des Projekts: ' + (error.message || 'Unbekannter Fehler'));
                }
            }
        }
        
        // Zeiteintr√§ge laden
        async function loadTimeEntries() {
            try {
                const timeEntriesContainer = document.getElementById('time-entries-container');
                timeEntriesContainer.innerHTML = '<p>Zeiteintr√§ge werden geladen...</p>';
                
                // Zeiteintr√§ge √ºber DataService laden
                const timeEntries = await DataService.getProjectTimeEntries(projectId);
                
                if (!timeEntries || timeEntries.length === 0) {
                    console.log('Keine Zeiteintr√§ge gefunden');
                    timeEntriesContainer.innerHTML = '<p>Keine Zeiteintr√§ge vorhanden.</p>';
                    return;
                }
                
                console.log(`${timeEntries.length} Zeiteintr√§ge gefunden`);
                
                // Nach Datum sortieren (neueste zuerst)
                timeEntries.sort((a, b) => {
                    // Sichere Konvertierung f√ºr verschiedene Timestamp-Formate
                    const getDateFromTimestamp = (timestamp) => {
                        if (!timestamp) return new Date(0);
                        if (timestamp instanceof firebase.firestore.Timestamp) return timestamp.toDate();
                        if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
                        return new Date(timestamp);
                    };
                    
                    // Zuerst clockOutTime pr√ºfen, dann clockInTime
                    const dateA = getDateFromTimestamp(a.clockOutTime || a.clockInTime);
                    const dateB = getDateFromTimestamp(b.clockOutTime || b.clockInTime);
                    
                    return dateB - dateA; // Absteigend (neuste zuerst)
                });
                
                // Mitarbeiterdaten laden
                const employeePromises = timeEntries.map(entry => 
                    entry.employeeId ? DataService.employeesCollection.doc(entry.employeeId).get() : Promise.resolve({ exists: false })
                );
                
                const employeeDocs = await Promise.all(employeePromises);
                const employees = employeeDocs.map(doc => 
                    doc.exists ? { id: doc.id, ...doc.data() } : { name: 'Unbekannt' }
                );
                
                // Zeiteintr√§ge anzeigen
                timeEntriesContainer.innerHTML = `
                    <table id="time-entries-table">
                        <thead>
                            <tr>
                                <th>Mitarbeiter</th>
                                <th>Datum</th>
                                <th>Einstempelzeit</th>
                                <th>Ausstempelzeit</th>
                                <th>Arbeitszeit</th>
                                <th>Notizen</th>
                            </tr>
                        </thead>
                        <tbody id="time-entries-body"></tbody>
                    </table>
                `;
                
                const tableBody = document.getElementById('time-entries-body');
                
                timeEntries.forEach((entry, index) => {
                    const employee = employees[index] || { name: 'Unbekannt' };
                    
                    // Datum formatieren
                    let date = 'Unbekannt';
                    let clockInTime = '-';
                    let clockOutTime = '-';
                    let workHours = '-';
                    
                    // Hilfsfunktion zum Sicheren Konvertieren von Zeitstempeln
                    function safelyConvertTimestamp(timestamp) {
                        if (!timestamp) return null;
                        
                        try {
                            // Firestore Timestamp konvertieren
                            if (timestamp instanceof firebase.firestore.Timestamp) {
                                return timestamp.toDate();
                            }
                            
                            // Unix-Timestamp als Nummer (Sekunden)
                            if (typeof timestamp === 'number') {
                                return new Date(timestamp * 1000);
                            }
                            
                            // Unix-Timestamp als String (Millisekunden)
                            if (typeof timestamp === 'string' && !isNaN(timestamp)) {
                                return new Date(parseInt(timestamp));
                            }
                            
                            // ISO-Datumsstring
                            if (typeof timestamp === 'string') {
                                const d = new Date(timestamp);
                                return isNaN(d.getTime()) ? null : d;
                            }
                            
                            // Date-Objekt
                            if (timestamp instanceof Date) {
                                return timestamp;
                            }
                            
                            // Firestore Servervalue-Timestamp-Objekt
                            if (timestamp && timestamp._seconds) {
                                return new Date(timestamp._seconds * 1000);
                            }
                            
                            return null;
                        } catch (e) {
                            console.error('Fehler bei der Zeitkonvertierung:', e, timestamp);
                            return null;
                        }
                    }
                    
                    // Einstempelzeit konvertieren und formatieren
                    const clockInDateObj = safelyConvertTimestamp(entry.clockInTime);
                    if (clockInDateObj) {
                        date = clockInDateObj.toLocaleDateString('de-DE');
                        clockInTime = clockInDateObj.toLocaleTimeString('de-DE', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    
                    // Ausstempelzeit konvertieren und formatieren
                    if (entry.clockOutTime) {
                        const clockOutDateObj = safelyConvertTimestamp(entry.clockOutTime);
                        if (clockOutDateObj) {
                            clockOutTime = clockOutDateObj.toLocaleTimeString('de-DE', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            
                            // Arbeitszeit berechnen, wenn beide Zeitstempel g√ºltig sind
                            if (clockInDateObj) {
                                const pauseTotalTime = entry.pauseTotalTime || 0;
                                const totalTimeMs = clockOutDateObj.getTime() - clockInDateObj.getTime();
                                const actualWorkTimeMs = totalTimeMs - pauseTotalTime;
                                
                                if (actualWorkTimeMs > 0) {
                                    const totalMinutes = Math.floor(actualWorkTimeMs / 60000);
                                    const hours = Math.floor(totalMinutes / 60);
                                    const minutes = totalMinutes % 60;
                                    workHours = `${hours}h ${minutes}min`;
                                }
                            }
                        }
                    }
                    
                    // Zeile erstellen
                    const row = document.createElement('tr');
                    
                    // Zellen hinzuf√ºgen
                    row.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${date}</td>
                        <td>${clockInTime}</td>
                        <td>${clockOutTime}</td>
                        <td>${workHours}</td>
                        <td>${entry.notes || '-'}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                console.log(`${timeEntries.length} Zeiteintr√§ge angezeigt`);
                
            } catch (error) {
                console.error('Fehler beim Laden der Zeiteintr√§ge:', error);
                const timeEntriesContainer = document.getElementById('time-entries-container');
                timeEntriesContainer.innerHTML = '<p class="error">Fehler beim Laden der Zeiteintr√§ge.</p>';
            }
        }
        
        // Bilder laden
        async function loadProjectImages(type) {
            try {
                console.log(`=== LADE ${type.toUpperCase()}-BILDER ===`);
                console.log(`Lade ${type}-Bilder f√ºr Projekt:`, projectId);
                const containerId = type === 'construction_site' ? 'construction-images' : 'documents-gallery';
                
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container mit ID ${containerId} nicht gefunden`);
                    return;
                }
                
                // Container leeren und Ladeindikator anzeigen
                container.innerHTML = `<p>${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'} werden geladen...</p>`;
                
                // ALLE Projektdateien √ºber den verbesserten DataService laden
                // Diese Funktion sucht in allen Quellen und Unterordnern
                if (!allProjectFiles) {
                    console.log('Lade alle Projektdateien erstmalig...');
                    allProjectFiles = await DataService.getProjectAllFiles(projectId);
                    console.log('Alle Projektdateien geladen:', allProjectFiles);
                }
                
                // Dateien je nach Typ ausw√§hlen
                const files = allProjectFiles[type] || [];
                console.log(`Anzahl ${type}-Dateien gefunden:`, files.length);
                
                if (!files || files.length === 0) {
                    console.log(`Keine ${type}-Bilder gefunden`);
                    container.innerHTML = `<p>Keine ${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'} vorhanden.</p>`;
                    return;
                }
                
                console.log(`${files.length} ${type}-Bilder/Dokumente werden angezeigt`);
                
                // Container leeren
                container.innerHTML = '';
                
                // Z√§hler f√ºr geladene Bilder (f√ºr Initialisierung der Lightbox)
                let loadedImages = 0;
                const totalImages = files.length;
                
                // Bilder zur Galerie hinzuf√ºgen
                for (let index = 0; index < files.length; index++) {
                    const file = files[index];
                    console.log(`Verarbeite Datei ${index + 1}/${files.length}:`, file);
                    
                    // Mitarbeiterinformationen abrufen (wenn vorhanden)
                    let employeeName = 'Unbekannt';
                    if (file.employeeId) {
                        try {
                            const employeeDoc = await DataService.employeesCollection.doc(file.employeeId).get();
                            if (employeeDoc.exists) {
                                employeeName = employeeDoc.data().name || 'Unbekannt';
                            }
                        } catch (error) {
                            console.warn('Fehler beim Laden des Mitarbeiters:', error);
                        }
                    }
                    
                    // Datum formatieren mit sicherer Konvertierungsfunktion
                    let formattedDate = 'Unbekanntes Datum';
                    
                    // Hilfsfunktion zum Sicheren Konvertieren von Zeitstempeln
                    function safelyConvertTimestamp(timestamp) {
                        if (!timestamp) return null;
                        
                        try {
                            // Firestore Timestamp konvertieren
                            if (timestamp instanceof firebase.firestore.Timestamp) {
                                return timestamp.toDate();
                            }
                            
                            // Unix-Timestamp als Nummer (Sekunden)
                            if (typeof timestamp === 'number') {
                                return new Date(timestamp * 1000);
                            }
                            
                            // Unix-Timestamp als String (Millisekunden)
                            if (typeof timestamp === 'string' && !isNaN(timestamp)) {
                                return new Date(parseInt(timestamp));
                            }
                            
                            // ISO-Datumsstring
                            if (typeof timestamp === 'string') {
                                const d = new Date(timestamp);
                                return isNaN(d.getTime()) ? null : d;
                            }
                            
                            // Date-Objekt
                            if (timestamp instanceof Date) {
                                return timestamp;
                            }
                            
                            // Firestore Servervalue-Timestamp-Objekt
                            if (timestamp && timestamp._seconds) {
                                return new Date(timestamp._seconds * 1000);
                            }
                            
                            return null;
                        } catch (e) {
                            console.error('Fehler bei der Zeitkonvertierung:', e, timestamp);
                            return null;
                        }
                    }
                    
                    // Versuche verschiedene Zeitstempel-Eigenschaften
                    let dateObj = null;
                    
                    if (file.timestamp) {
                        dateObj = safelyConvertTimestamp(file.timestamp);
                    } 
                    
                    if (!dateObj && file.uploadDate) {
                        dateObj = safelyConvertTimestamp(file.uploadDate);
                    }
                    
                    if (!dateObj && file.uploadTime) {
                        dateObj = safelyConvertTimestamp(file.uploadTime);
                    }
                    
                    if (dateObj) {
                        formattedDate = dateObj.toLocaleDateString('de-DE');
                    }
                    
                    // Galerie-Element erstellen
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    
                    // Bild-Element erstellen
                    const img = document.createElement('img');
                    img.className = 'gallery-img';
                    img.src = file.url || file.downloadURL || '';
                    img.alt = type === 'construction_site' ? 'Baustellenfoto' : 'Dokument';
                    
                    // Bild-Lade√ºberwachung f√ºr Lightbox-Initialisierung
                    img.onload = function() {
                        loadedImages++;
                        console.log(`Bild ${loadedImages}/${totalImages} geladen`);
                        // Initialisiere Lightbox, wenn alle Bilder geladen sind
                        if (loadedImages === totalImages) {
                            console.log('Alle Bilder geladen, initialisiere Lightbox');
                            initializeLightboxAfterLoad();
                        }
                    };
                    
                    img.onerror = function() {
                        loadedImages++;
                        console.error('Fehler beim Laden des Bildes:', file.url || file.downloadURL);
                        // Selbst bei Fehler √ºberpr√ºfen, ob wir mit der Initialisierung fortfahren k√∂nnen
                        if (loadedImages === totalImages) {
                            console.log('Alle Bilder verarbeitet (mit Fehlern), initialisiere Lightbox');
                            initializeLightboxAfterLoad();
                        }
                    };
                    
                    // Beschreibung erstellen
                    const description = document.createElement('p');
                    description.textContent = `${employeeName} - ${formattedDate}`;
                    
                    // Kommentar hinzuf√ºgen, wenn vorhanden
                    if (file.comment) {
                        const commentContainer = document.createElement('div');
                        commentContainer.className = 'image-comment';
                        commentContainer.innerHTML = `<strong>Kommentar:</strong> ${file.comment}`;
                        galleryItem.appendChild(commentContainer);
                    }
                    
                    // Elemente zusammenf√ºgen
                    galleryItem.appendChild(img);
                    galleryItem.appendChild(description);
                    
                    // In die Galerie einf√ºgen
                    container.appendChild(galleryItem);
                }
                
                console.log(`=== ${files.length} ${type === 'construction_site' ? 'BAUSTELLENFOTOS' : 'DOKUMENTE'} ERFOLGREICH ANGEZEIGT ===`);
                
            } catch (error) {
                console.error(`=== FEHLER BEIM LADEN DER ${type.toUpperCase()}-BILDER ===`);
                console.error('Fehler-Details:', error);
                const containerId = type === 'construction_site' ? 'construction-images' : 'documents-gallery';
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<p class="error">Fehler beim Laden der ${type === 'construction_site' ? 'Baustellenfotos' : 'Dokumente'}: ${error.message || 'Unbekannter Fehler'}</p>`;
                }
            }
        }
    </script>
    <!-- Lightbox Container -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close">&times;</button>
            <img class="lightbox-img" id="lightbox-img" src="" alt="Vergr√∂√üertes Bild">
            <div class="lightbox-controls">
                <button class="lightbox-prev">&lsaquo;</button>
                <button class="lightbox-next">&rsaquo;</button>
            </div>
        </div>
        <div class="lightbox-caption" id="lightbox-caption"></div>
    </div>

    <script>
        // Lightbox-Funktionalit√§t
        let currentGallery = [];
        let currentImageIndex = 0;
        
        function setupLightbox() {
            // Alle Bilder in den Galerien mit Click-Event versehen
            document.querySelectorAll('.gallery-item').forEach(item => {
                item.addEventListener('click', function() {
                    const img = this.querySelector('img');
                    const imgSrc = img.src;
                    const caption = this.querySelector('p')?.textContent || '';
                    
                    // Pr√ºfen, in welcher Galerie wir sind
                    const galleryContainer = this.closest('.gallery');
                    currentGallery = Array.from(galleryContainer.querySelectorAll('.gallery-item'));
                    currentImageIndex = currentGallery.indexOf(this);
                    
                    openLightbox(imgSrc, caption);
                });
            });
            
            // Lightbox schlie√üen bei Klick auf Schlie√üen-Button
            document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);
            
            // Schlie√üen bei Klick au√üerhalb des Bildes
            document.getElementById('lightbox').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLightbox();
                }
            });
            
            // Vor- und Zur√ºck-Buttons
            document.querySelector('.lightbox-prev').addEventListener('click', function(e) {
                e.stopPropagation();
                navigateLightbox(-1);
            });
            
            document.querySelector('.lightbox-next').addEventListener('click', function(e) {
                e.stopPropagation();
                navigateLightbox(1);
            });
            
            // Tastaturnavigation
            document.addEventListener('keydown', function(e) {
                if (!document.getElementById('lightbox').classList.contains('active')) return;
                
                if (e.key === 'Escape') {
                    closeLightbox();
                } else if (e.key === 'ArrowLeft') {
                    navigateLightbox(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateLightbox(1);
                }
            });
        }
        
        function openLightbox(imgSrc, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxCaption = document.getElementById('lightbox-caption');
            
            lightboxImg.src = imgSrc;
            lightboxCaption.textContent = caption;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden'; // Verhindert Scrollen im Hintergrund
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = ''; // Scrollen wieder erlauben
        }
        
        function navigateLightbox(direction) {
            currentImageIndex = (currentImageIndex + direction + currentGallery.length) % currentGallery.length;
            const newItem = currentGallery[currentImageIndex];
            const newImg = newItem.querySelector('img');
            const newCaption = newItem.querySelector('p')?.textContent || '';
            
            document.getElementById('lightbox-img').src = newImg.src;
            document.getElementById('lightbox-caption').textContent = newCaption;
        }
        
        // Lightbox initialisieren, wenn Seite geladen ist
        document.addEventListener('DOMContentLoaded', setupLightbox);
        
        // Lightbox initialisieren, wenn Bilder dynamisch geladen werden
        function initializeLightboxAfterLoad() {
            setupLightbox();
        }
        
        // Die PDF-Export-Funktion wurde in pdf-export.js ausgelagert
        // Export-Button Event-Listener wird im DOMContentLoaded-Event gesetzt
    </script>
    
    <!-- Report-functions und PDF-Export am Ende laden -->
    <script src="report-functions.js"></script>
    <script src="pdf-export.js"></script>
</body>
</html>
